<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur Texte-Voix Naturelle avec T√©l√©chargement</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            padding: 40px;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.8rem;
            background: linear-gradient(90deg, #1a2a6c, #b21f1f);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .api-section {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #2196f3;
        }

        .api-section h3 {
            color: #0d47a1;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-input {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .api-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #90caf9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .api-input input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
        }

        .api-input button {
            background: linear-gradient(90deg, #2196f3, #1976d2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .api-input button:hover {
            background: linear-gradient(90deg, #1976d2, #1565c0);
            transform: translateY(-2px);
        }

        .api-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .api-status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .api-status.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #ff9800;
        }

        .api-status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .input-section, .controls-section, .voices-section, .download-section {
            margin-bottom: 30px;
        }

        h2 {
            color: #34495e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stats span {
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 20px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #ddd, #3498db);
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .value-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .voices-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .voice-option {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .voice-option:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
            transform: translateY(-3px);
        }

        .voice-option.selected {
            border-color: #2ecc71;
            background-color: #e8f6f3;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.2);
        }

        .voice-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .voice-lang {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
        }

        .play-btn {
            background: linear-gradient(90deg, #2ecc71, #1abc9c);
            color: white;
        }

        .play-btn:hover {
            background: linear-gradient(90deg, #27ae60, #16a085);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .stop-btn {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: white;
        }

        .stop-btn:hover {
            background: linear-gradient(90deg, #c0392b, #a93226);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .pause-btn {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
        }

        .pause-btn:hover {
            background: linear-gradient(90deg, #2980b9, #1c5a7d);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .reset-btn {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            color: white;
        }

        .reset-btn:hover {
            background: linear-gradient(90deg, #e67e22, #d35400);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .download-btn {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            color: white;
        }

        .download-btn:hover {
            background: linear-gradient(90deg, #8e44ad, #7d3c98);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .status.ready {
            background-color: #e8f6f3;
            color: #27ae60;
        }

        .status.speaking {
            background-color: #ebf5fb;
            color: #2980b9;
        }

        .status.paused {
            background-color: #fef9e7;
            color: #f39c12;
        }

        .status.stopped {
            background-color: #fbebee;
            color: #e74c3c;
        }

        .status.generating {
            background-color: #f3e5f5;
            color: #9b59b6;
        }

        .example-text {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
            cursor: pointer;
            text-decoration: underline;
            display: inline-block;
        }

        .example-text:hover {
            color: #3498db;
        }

        .instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .instructions ul {
            padding-left: 20px;
            color: #555;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .download-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .download-option {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ecf0f1;
            transition: all 0.3s;
        }

        .download-option:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .download-option h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .download-option p {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            width: 100%;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .voice-option {
                min-width: 100%;
            }
            
            button {
                min-width: 100%;
            }
            
            .api-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Convertisseur Texte-Voix avec T√©l√©chargement</h1>
            <p class="subtitle">Transformez votre texte en parole naturelle et t√©l√©chargez l'audio en MP3</p>
        </header>

        <!-- Section API VoiceRSS -->
        <section class="api-section">
            <h3>üîë Configuration VoiceRSS API (pour t√©l√©chargement)</h3>
            <p>Obtenez une cl√© API gratuite sur <a href="https://www.voicerss.org" target="_blank" style="color: #2196f3; font-weight: bold;">voicerss.org</a> (350 requ√™tes/jour gratuites)</p>
            <div class="api-input">
                <input type="text" id="apiKey" placeholder="Collez votre cl√© API VoiceRSS ici">
                <button onclick="saveApiKey()">üíæ Enregistrer la cl√©</button>
            </div>
            <div id="apiStatus" class="api-status warning">
                ‚ö†Ô∏è Aucune cl√© API configur√©e. Utilisez la cl√© de d√©monstration (limit√©).
            </div>
        </section>

        <section class="input-section">
            <h2>Texte √† convertir</h2>
            <textarea id="textInput" placeholder="√âcrivez ou collez votre texte ici...">Bonjour ! Je suis votre assistant vocal. Je peux lire votre texte avec une voix naturelle, en respectant parfaitement la ponctuation : les virgules, les points, les points d'interrogation et d'exclamation.

Cette technologie utilise l'API de synth√®se vocale de votre navigateur. Vous pouvez ajuster la vitesse, le volume et choisir parmi diff√©rentes voix disponibles.

Essayez avec votre propre texte !</textarea>
            <div class="stats">
                <span id="charCount">0 caract√®res</span>
                <span id="wordCount">0 mots</span>
                <span id="sentenceCount">0 phrases</span>
                <span id="apiLimit">Limite API: 300 caract√®res</span>
            </div>
            <p class="example-text" id="loadExample">Charger un exemple de texte avec ponctuation</p>
        </section>

        <section class="controls-section">
            <h2>Param√®tres de la voix</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="rate">Vitesse de parole</label>
                    <div class="slider-container">
                        <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="rateValue">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="pitch">Ton de la voix</label>
                    <div class="slider-container">
                        <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="pitchValue">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="volume">Volume</label>
                    <div class="slider-container">
                        <input type="range" id="volume" min="0" max="1" step="0.1" value="1">
                        <span class="value-display" id="volumeValue">1.0</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="voices-section">
            <h2>S√©lectionnez une voix</h2>
            <p id="voicesLoading">Chargement des voix disponibles...</p>
            <div class="voices-container" id="voicesContainer">
                <!-- Les options de voix seront ajout√©es dynamiquement -->
            </div>
        </section>

        <section class="download-section">
            <h2>Options de t√©l√©chargement VoiceRSS</h2>
            <div class="download-options">
                <div class="download-option">
                    <h4>üåç Langue et Voix</h4>
                    <select id="apiVoiceSelect" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd; margin-top: 10px;">
                        <option value="fr-fr">Fran√ßais - France (f√©minine)</option>
                        <option value="fr-ca">Fran√ßais - Canada (f√©minine)</option>
                        <option value="en-us">Anglais - √âtats-Unis (f√©minine)</option>
                        <option value="en-gb">Anglais - Royaume-Uni (f√©minine)</option>
                        <option value="de-de">Allemand - Allemagne (f√©minine)</option>
                        <option value="es-es">Espagnol - Espagne (f√©minine)</option>
                    </select>
                </div>
                
                <div class="download-option">
                    <h4>üéµ Format Audio</h4>
                    <select id="apiFormatSelect" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd; margin-top: 10px;">
                        <option value="mp3">MP3 (recommand√©)</option>
                        <option value="wav">WAV</option>
                        <option value="aac">AAC</option>
                        <option value="ogg">OGG</option>
                        <option value="caf">CAF</option>
                    </select>
                </div>
                
                <div class="download-option">
                    <h4>‚ö° Qualit√© Audio</h4>
                    <select id="apiQualitySelect" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #ddd; margin-top: 10px;">
                        <option value="44khz_16bit_stereo">Haute qualit√© (44kHz)</option>
                        <option value="48khz_16bit_stereo">Qualit√© sup√©rieure (48kHz)</option>
                        <option value="22khz_16bit_mono">Standard (22kHz)</option>
                        <option value="8khz_8bit_mono">Faible qualit√© (8kHz)</option>
                    </select>
                </div>
            </div>
        </section>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>G√©n√©ration de l'audio en cours...</p>
            <p><small>Veuillez patienter pendant la cr√©ation du fichier MP3</small></p>
        </div>

        <div class="buttons">
            <button id="playBtn" class="play-btn">
                <span>‚ñ∂ Lire le texte</span>
            </button>
            <button id="pauseBtn" class="pause-btn" disabled>
                <span>‚è∏ Pause</span>
            </button>
            <button id="resumeBtn" class="pause-btn" disabled>
                <span>‚ñ∂ Reprendre</span>
            </button>
            <button id="stopBtn" class="stop-btn" disabled>
                <span>‚èπ Arr√™ter</span>
            </button>
            <button id="generateBtn" class="download-btn">
                <span>‚¨á G√©n√©rer & T√©l√©charger</span>
            </button>
            <button id="resetBtn" class="reset-btn">
                <span>‚Ü∫ R√©initialiser</span>
            </button>
        </div>

        <div class="status ready" id="status">
            Pr√™t √† convertir le texte en voix
        </div>

        <div class="instructions">
            <h3>Instructions d'utilisation</h3>
            <ul>
                <li><strong>Pour la lecture navigateur :</strong> Utilisez les boutons Lecture/Pause/Arr√™ter</li>
                <li><strong>Pour t√©l√©charger l'audio :</strong> 
                    <ol>
                        <li>Obtenez une cl√© API gratuite sur voicerss.org</li>
                        <li>Collez la cl√© dans le champ "Configuration VoiceRSS API"</li>
                        <li>Configurez les param√®tres de langue et format</li>
                        <li>Cliquez sur "G√©n√©rer & T√©l√©charger"</li>
                    </ol>
                </li>
                <li><strong>Limitations :</strong> VoiceRSS gratuit limite √† 300 caract√®res par requ√™te. Pour des textes plus longs, divisez votre texte.</li>
                <li><strong>Note :</strong> L'outil respecte automatiquement la ponctuation pour une lecture naturelle</li>
            </ul>
        </div>
    </div>

    <footer>
        <p>Outil de synth√®se vocale utilisant l'API Web Speech + VoiceRSS API pour le t√©l√©chargement</p>
    </footer>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        // Cl√© API VoiceRSS de d√©monstration (limite de 300 caract√®res)
        const DEMO_API_KEY = "9e8d84a1562443d898dd84917ff45f1b";

        // √âl√©ments DOM
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const sentenceCount = document.getElementById('sentenceCount');
        const rateSlider = document.getElementById('rate');
        const rateValue = document.getElementById('rateValue');
        const pitchSlider = document.getElementById('pitch');
        const pitchValue = document.getElementById('pitchValue');
        const volumeSlider = document.getElementById('volume');
        const volumeValue = document.getElementById('volumeValue');
        const voicesContainer = document.getElementById('voicesContainer');
        const voicesLoading = document.getElementById('voicesLoading');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const generateBtn = document.getElementById('generateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const status = document.getElementById('status');
        const loadExample = document.getElementById('loadExample');
        const apiKeyInput = document.getElementById('apiKey');
        const apiStatus = document.getElementById('apiStatus');
        const apiVoiceSelect = document.getElementById('apiVoiceSelect');
        const apiFormatSelect = document.getElementById('apiFormatSelect');
        const apiQualitySelect = document.getElementById('apiQualitySelect');
        const loading = document.getElementById('loading');

        // Variables globales
        let synth = window.speechSynthesis;
        let voices = [];
        let selectedVoice = null;
        let isPlaying = false;
        let isPaused = false;
        let currentUtterance = null;
        let userApiKey = null;
        let currentAudioUrl = null;
        let currentAudioBlob = null;

        // ============================================
        // INITIALISATION
        // ============================================

        // Initialiser le compteur de caract√®res
        updateTextStats();
        textInput.addEventListener('input', updateTextStats);

        // Initialiser les sliders
        rateSlider.addEventListener('input', () => {
            rateValue.textContent = rateSlider.value;
        });

        pitchSlider.addEventListener('input', () => {
            pitchValue.textContent = pitchSlider.value;
        });

        volumeSlider.addEventListener('input', () => {
            volumeValue.textContent = volumeSlider.value;
        });

        // Charger la cl√© API sauvegard√©e
        loadSavedApiKey();

        // ============================================
        // FONCTIONS UTILITAIRES
        // ============================================

        function updateTextStats() {
            const text = textInput.value;
            const charCountValue = text.length;
            const wordCountValue = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            
            // Compter les phrases (s√©par√©es par . ! ?)
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const sentenceCountValue = sentences.length;
            
            charCount.textContent = `${charCountValue} caract√®res`;
            wordCount.textContent = `${wordCountValue} mots`;
            sentenceCount.textContent = `${sentenceCountValue} phrases`;
            
            // Mettre √† jour la couleur du compteur de caract√®res selon la limite
            if (charCountValue > 300) {
                charCount.style.color = '#e74c3c';
                charCount.innerHTML = `${charCountValue} caract√®res <span style="color: #666">(trop long pour VoiceRSS gratuit)</span>`;
            } else if (charCountValue > 200) {
                charCount.style.color = '#f39c12';
            } else {
                charCount.style.color = '#2ecc71';
            }
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('voiceRssApiKey', key);
                userApiKey = key;
                apiStatus.textContent = '‚úÖ Cl√© API enregistr√©e avec succ√®s';
                apiStatus.className = 'api-status success';
                alert('Cl√© API sauvegard√©e ! Vous pouvez maintenant g√©n√©rer et t√©l√©charger des audios.');
            } else {
                alert('Veuillez entrer une cl√© API valide');
            }
        }

        function loadSavedApiKey() {
            const savedKey = localStorage.getItem('voiceRssApiKey');
            if (savedKey) {
                apiKeyInput.value = savedKey;
                userApiKey = savedKey;
                apiStatus.textContent = '‚úÖ Utilisation de votre cl√© API personnelle';
                apiStatus.className = 'api-status success';
            } else {
                // Utiliser la cl√© de d√©monstration par d√©faut
                userApiKey = DEMO_API_KEY;
                apiStatus.textContent = '‚ö†Ô∏è Utilisation de la cl√© de d√©monstration (limit√©e √† 300 caract√®res)';
                apiStatus.className = 'api-status warning';
            }
        }

        function formatTextForAPI(text) {
            // Nettoyer le texte pour l'API
            return text
                .replace(/\n+/g, ' ')  // Remplacer les sauts de ligne par des espaces
                .replace(/\s+/g, ' ')  // Supprimer les espaces multiples
                .trim()
                .substring(0, 300);    // Limiter √† 300 caract√®res pour la version gratuite
        }

        // ============================================
        // SYNTH√àSE VOCALE DU NAVIGATEUR
        // ============================================

        // Charger les voix disponibles
        function loadVoices() {
            voices = synth.getVoices();
            voicesLoading.style.display = 'none';
            voicesContainer.innerHTML = '';
            
            // Filtrer pour obtenir principalement des voix en fran√ßais
            const frenchVoices = voices.filter(voice => 
                voice.lang.startsWith('fr') || 
                voice.lang.startsWith('en') || 
                voice.name.toLowerCase().includes('french')
            );
            
            // Si pas de voix en fran√ßais, montrer toutes les voix
            const voicesToShow = frenchVoices.length > 0 ? frenchVoices : voices;
            
            if (voicesToShow.length === 0) {
                voicesContainer.innerHTML = '<p style="color: #e74c3c; padding: 20px; text-align: center;">Aucune voix disponible. Votre navigateur peut ne pas supporter la synth√®se vocale.</p>';
                return;
            }
            
            // Trier les voix par langue
            voicesToShow.sort((a, b) => {
                if (a.lang < b.lang) return -1;
                if (a.lang > b.lang) return 1;
                return 0;
            });
            
            // Cr√©er les options de voix
            voicesToShow.forEach((voice, index) => {
                const voiceOption = document.createElement('div');
                voiceOption.className = 'voice-option';
                if (index === 0) {
                    voiceOption.classList.add('selected');
                    selectedVoice = voice;
                }
                
                voiceOption.innerHTML = `
                    <div class="voice-name">${voice.name}</div>
                    <div class="voice-lang">${voice.lang} - ${voice.localService ? 'Locale' : 'R√©seau'}</div>
                `;
                
                voiceOption.addEventListener('click', () => {
                    // Retirer la s√©lection de toutes les voix
                    document.querySelectorAll('.voice-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    
                    // Ajouter la s√©lection √† la voix choisie
                    voiceOption.classList.add('selected');
                    selectedVoice = voice;
                });
                
                voicesContainer.appendChild(voiceOption);
            });
        }

        // Initialiser les voix
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }

        // Charger les voix au d√©marrage
        loadVoices();

        // G√©rer la lecture du texte
        playBtn.addEventListener('click', () => {
            if (isPlaying && !isPaused) {
                return;
            }
            
            const text = textInput.value.trim();
            if (text === '') {
                alert('Veuillez saisir du texte √† lire.');
                return;
            }
            
            if (!selectedVoice) {
                alert('Aucune voix s√©lectionn√©e. Veuillez choisir une voix.');
                return;
            }
            
            // Arr√™ter toute lecture en cours
            if (currentUtterance) {
                synth.cancel();
            }
            
            // Cr√©er une nouvelle utterance
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            // Configurer l'utterance
            currentUtterance.voice = selectedVoice;
            currentUtterance.rate = parseFloat(rateSlider.value);
            currentUtterance.pitch = parseFloat(pitchSlider.value);
            currentUtterance.volume = parseFloat(volumeSlider.value);
            
            // G√©rer les √©v√©nements
            currentUtterance.onstart = () => {
                isPlaying = true;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture en cours...';
                status.className = 'status speaking';
            };
            
            currentUtterance.onend = () => {
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture termin√©e';
                status.className = 'status ready';
            };
            
            currentUtterance.onerror = (event) => {
                console.error('Erreur de synth√®se vocale:', event);
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Erreur lors de la lecture';
                status.className = 'status stopped';
            };
            
            currentUtterance.onpause = () => {
                isPaused = true;
                updateButtons();
                status.textContent = 'Lecture en pause';
                status.className = 'status paused';
            };
            
            currentUtterance.onresume = () => {
                isPaused = false;
                updateButtons();
                status.textContent = 'Reprise de la lecture';
                status.className = 'status speaking';
            };
            
            // D√©marrer la synth√®se
            synth.speak(currentUtterance);
        });

        // G√©rer la pause
        pauseBtn.addEventListener('click', () => {
            if (isPlaying && !isPaused) {
                synth.pause();
                isPaused = true;
                updateButtons();
                status.textContent = 'Lecture en pause';
                status.className = 'status paused';
            }
        });

        // G√©rer la reprise
        resumeBtn.addEventListener('click', () => {
            if (isPlaying && isPaused) {
                synth.resume();
                isPaused = false;
                updateButtons();
                status.textContent = 'Reprise de la lecture';
                status.className = 'status speaking';
            }
        });

        // G√©rer l'arr√™t
        stopBtn.addEventListener('click', () => {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            updateButtons();
            status.textContent = 'Lecture arr√™t√©e';
            status.className = 'status stopped';
        });

        // G√©rer la r√©initialisation
        resetBtn.addEventListener('click', () => {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            
            // R√©initialiser les sliders
            rateSlider.value = 1;
            rateValue.textContent = '1.0';
            pitchSlider.value = 1;
            pitchValue.textContent = '1.0';
            volumeSlider.value = 1;
            volumeValue.textContent = '1.0';
            
            // R√©initialiser le texte
            textInput.value = '';
            updateTextStats();
            
            // R√©initialiser la s√©lection de voix
            if (voices.length > 0) {
                document.querySelectorAll('.voice-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.querySelector('.voice-option').classList.add('selected');
                selectedVoice = voices[0];
            }
            
            updateButtons();
            status.textContent = 'Pr√™t √† convertir le texte en voix';
            status.className = 'status ready';
        });

        // Mettre √† jour l'√©tat des boutons
        function updateButtons() {
            playBtn.disabled = isPlaying && !isPaused;
            pauseBtn.disabled = !isPlaying || isPaused;
            resumeBtn.disabled = !isPlaying || !isPaused;
            stopBtn.disabled = !isPlaying;
        }

        // Charger un exemple de texte
        loadExample.addEventListener('click', () => {
            textInput.value = `La synth√®se vocale, ou text-to-speech (TTS), est une technologie qui convertit le texte en parole artificielle.

Cette technologie est utilis√©e dans de nombreux domaines : assistance aux personnes malvoyantes, navigation GPS, assistants vocaux, et bien plus encore.

Le respect de la ponctuation est essentiel pour une lecture naturelle. Par exemple, une virgule introduit une courte pause, un point une pause plus longue, et un point d'interrogation modifie l'intonation de la voix.

Avec cet outil, vous pouvez :
1. Ajuster la vitesse de lecture
2. Modifier le ton de la voix
3. Choisir parmi diff√©rentes voix disponibles
4. Contr√¥ler le volume de la sortie

Essayez avec votre propre texte maintenant !`;
            updateTextStats();
        });

        // ============================================
        // VOICERSS API - G√âN√âRATION ET T√âL√âCHARGEMENT
        // ============================================

        // G√©n√©rer et t√©l√©charger l'audio avec VoiceRSS
        generateBtn.addEventListener('click', async function() {
            const text = textInput.value.trim();
            
            if (!text) {
                alert('Veuillez saisir du texte √† convertir en audio.');
                return;
            }

            if (text.length > 300) {
                const confirm = window.confirm(`Votre texte fait ${text.length} caract√®res. VoiceRSS gratuit limite √† 300 caract√®res.\n\nVoulez-vous tronquer le texte √† 300 caract√®res ?`);
                if (!confirm) {
                    return;
                }
            }

            // Utiliser la cl√© API
            const apiKey = userApiKey || DEMO_API_KEY;
            
            if (!apiKey) {
                alert('Veuillez configurer votre cl√© API VoiceRSS d\'abord.');
                return;
            }

            // Afficher le chargement
            loading.style.display = 'block';
            status.textContent = 'G√©n√©ration de l\'audio en cours...';
            status.className = 'status generating';
            this.disabled = true;

            try {
                // Formater le texte pour l'API
                const formattedText = formatTextForAPI(text);
                
                // Pr√©parer les param√®tres
                const params = {
                    key: apiKey,
                    src: formattedText,
                    hl: apiVoiceSelect.value,
                    c: apiFormatSelect.value,
                    f: apiQualitySelect.value,
                    r: '0', // Vitesse (0 = normale)
                    ssml: 'false',
                    b64: 'false'
                };
                
                // Construire l'URL
                const queryString = Object.keys(params)
                    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                    .join('&');
                
                const apiUrl = `https://api.voicerss.org/?${queryString}`;
                
                console.log('Appel API VoiceRSS...');
                
                // Faire la requ√™te
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status}`);
                }
                
                const audioBlob = await response.blob();
                
                if (audioBlob.size < 100) {
                    throw new Error('Fichier audio trop petit ou invalide');
                }
                
                // Cr√©er l'URL pour le blob
                if (currentAudioUrl) {
                    URL.revokeObjectURL(currentAudioUrl);
                }
                currentAudioUrl = URL.createObjectURL(audioBlob);
                currentAudioBlob = audioBlob;
                
                // Cr√©er un lien de t√©l√©chargement
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `audio-${timestamp}.${apiFormatSelect.value}`;
                
                const link = document.createElement('a');
                link.href = currentAudioUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Lib√©rer l'URL apr√®s un d√©lai
                setTimeout(() => {
                    URL.revokeObjectURL(currentAudioUrl);
                }, 100);
                
                // Mettre √† jour le statut
                loading.style.display = 'none';
                status.textContent = '‚úÖ Audio g√©n√©r√© et t√©l√©charg√© avec succ√®s !';
                status.className = 'status ready';
                
                alert(`Audio t√©l√©charg√© avec succ√®s !\n\nFichier: ${filename}\nTaille: ${(audioBlob.size / 1024).toFixed(2)} KB`);
                
            } catch (error) {
                console.error('Erreur:', error);
                loading.style.display = 'none';
                status.textContent = '‚ùå Erreur lors de la g√©n√©ration de l\'audio';
                status.className = 'status stopped';
                
                alert(`Erreur : ${error.message}\n\nSolutions possibles :\n1. V√©rifiez votre cl√© API\n2. R√©duisez le texte √† moins de 300 caract√®res\n3. V√©rifiez votre connexion internet\n4. R√©essayez dans quelques instants`);
            } finally {
                this.disabled = false;
            }
        });

        // ============================================
        // INITIALISATION FINALE
        // ============================================

        // Initialiser l'√©tat des boutons
        updateButtons();

        // Message de bienvenue
        console.log(`
        ========================================
        CONVERTISSEUR TEXTE-VOIX AVEC T√âL√âCHARGEMENT
        ========================================
        Fonctionnalit√©s :
        ‚úÖ Lecture navigateur avec Web Speech API
        ‚úÖ T√©l√©chargement MP3 avec VoiceRSS API
        ‚úÖ S√©lection de voix multiples
        ‚úÖ R√©glage vitesse/ton/volume
        ‚úÖ Respect de la ponctuation
        
        Cl√© API actuelle : ${userApiKey ? '‚úì Configur√©e' : '‚úó D√©mo'}
        ========================================
        `);
    </script>
</body>
</html>
