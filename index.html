<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur Texte-Voix Naturelle avec VoiceRSS & TTSMaker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1100px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            padding: 40px;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.8rem;
            background: linear-gradient(90deg, #1a2a6c, #b21f1f);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .input-section, .controls-section, .voices-section, .apikey-section {
            margin-bottom: 30px;
        }

        h2 {
            color: #34495e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }

        .api-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .api-input-group {
            flex: 1;
            min-width: 300px;
        }

        .api-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .api-note {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .api-note a {
            color: #3498db;
            text-decoration: none;
        }

        .api-note a:hover {
            text-decoration: underline;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stats span {
            background-color: #f8f9fa;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
        }

        .value-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }

        /* Styles pour les options de voix */
        .voices-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .voice-option {
            flex: 1;
            min-width: 180px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-option:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }

        .voice-option.selected {
            border-color: #2ecc71;
            background-color: #e8f6f3;
        }

        .voice-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .voice-details {
            color: #7f8c8d;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }

        .voice-lang {
            background-color: #e8f4fc;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .voice-gender {
            font-weight: bold;
        }

        .voice-gender.male {
            color: #3498db;
        }

        .voice-gender.female {
            color: #e74c3c;
        }

        /* Styles pour le sélecteur de voix VoiceRSS */
        .voice-rss-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .voice-rss-option {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .voice-rss-option:hover {
            border-color: #3498db;
            background-color: #f0f8ff;
        }

        .voice-rss-option.selected {
            border-color: #9b59b6;
            background-color: #f4ecf7;
        }

        .voice-rss-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .voice-rss-details {
            color: #7f8c8d;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        /* Styles pour les voix TTSMaker */
        .ttsmaker-voices {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .ttsmaker-voice {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .ttsmaker-voice:hover {
            border-color: #2ecc71;
            background-color: #e8f6f3;
        }

        .ttsmaker-voice.selected {
            border-color: #2ecc71;
            background-color: #d4efdf;
        }

        .ttsmaker-voice-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
        }

        .play-btn {
            background: linear-gradient(90deg, #2ecc71, #1abc9c);
            color: white;
        }

        .play-btn:hover {
            background: linear-gradient(90deg, #27ae60, #16a085);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .stop-btn {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: white;
        }

        .stop-btn:hover {
            background: linear-gradient(90deg, #c0392b, #a93226);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .pause-btn {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
        }

        .pause-btn:hover {
            background: linear-gradient(90deg, #2980b9, #1c5a7d);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .reset-btn {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            color: white;
        }

        .reset-btn:hover {
            background: linear-gradient(90deg, #e67e22, #d35400);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .download-btn {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            color: white;
        }

        .download-btn:hover {
            background: linear-gradient(90deg, #8e44ad, #7d3c98);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .status.ready {
            background-color: #e8f6f3;
            color: #27ae60;
        }

        .status.speaking {
            background-color: #ebf5fb;
            color: #2980b9;
        }

        .status.paused {
            background-color: #fef9e7;
            color: #f39c12;
        }

        .status.stopped {
            background-color: #fbebee;
            color: #e74c3c;
        }

        .status.processing {
            background-color: #f4ecf7;
            color: #9b59b6;
        }

        .example-text {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
            cursor: pointer;
            text-decoration: underline;
            display: inline-block;
        }

        .example-text:hover {
            color: #3498db;
        }

        .instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .instructions ul {
            padding-left: 20px;
            color: #555;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            width: 100%;
        }

        .engine-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .engine-option {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .engine-option:hover {
            border-color: #3498db;
            background-color: #f0f8ff;
        }

        .engine-option.selected {
            border-color: #2ecc71;
            background-color: #e8f6f3;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background-color: #fbebee;
            color: #e74c3c;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .success-message {
            background-color: #e8f6f3;
            color: #27ae60;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .warning-message {
            background-color: #fef9e7;
            color: #f39c12;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .service-info {
            background-color: #e8f4fc;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            border-left: 4px solid #3498db;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .voice-option, .api-input-group, .voice-rss-option, .ttsmaker-voice {
                min-width: 100%;
            }
            
            button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Convertisseur Texte-Voix Naturelle</h1>
            <p class="subtitle">Transformez votre texte en parole naturelle avec téléchargement MP3</p>
        </header>

        <section class="apikey-section">
            <h2>Configuration des Services</h2>
            <div class="engine-selector">
                <div class="engine-option selected" id="engineBrowser">Moteur Navigateur</div>
                <div class="engine-option" id="engineVoiceRSS">VoiceRSS</div>
                <div class="engine-option" id="engineTTSMaker">TTSMaker (Alternative Gratuite)</div>
            </div>
            
            <div id="voiceRSSConfig" class="hidden">
                <div class="api-container">
                    <div class="api-input-group">
                        <label for="apiKey">Clé API VoiceRSS</label>
                        <input type="text" id="apiKey" placeholder="Entrez votre clé API VoiceRSS" value="a14541231b764962942cac8697f2ca29">
                    </div>
                </div>
                <p class="api-note">
                    <strong>✅ Votre clé API VoiceRSS est configurée.</strong> La version gratuite offre 350 requêtes par jour.
                    Les voix masculines peuvent ne pas être disponibles dans le plan gratuit.
                </p>
            </div>
            
            <div id="ttsMakerConfig" class="hidden">
                <div class="api-container">
                    <div class="api-input-group">
                        <label for="ttsMakerKey">Clé API TTSMaker (Optionnelle)</label>
                        <input type="text" id="ttsMakerKey" placeholder="Entrez votre clé API TTSMaker (optionnel)">
                    </div>
                </div>
                <p class="api-note">
                    <strong>TTSMaker offre 10 000 caractères gratuits par mois</strong> sans besoin d'inscription pour les voix masculines.
                    Obtenez une clé API sur <a href="https://ttsmaker.com/" target="_blank">TTSMaker.com</a> pour plus de caractères.
                </p>
            </div>
        </section>

        <section class="input-section">
            <h2>Texte à convertir</h2>
            <textarea id="textInput" placeholder="Écrivez ou collez votre texte ici...">Bonjour ! Je suis votre assistant vocal. Je peux lire votre texte avec une voix naturelle, en respectant parfaitement la ponctuation : les virgules, les points, les points d'interrogation et d'exclamation.

Cette technologie utilise l'API de synthèse vocale de votre navigateur, VoiceRSS ou TTSMaker. Vous pouvez ajuster la vitesse, le volume et choisir parmi différentes voix disponibles.

Avec VoiceRSS et TTSMaker, vous pouvez également télécharger le fichier audio en MP3 pour l'utiliser hors ligne.</textarea>
            <div class="stats">
                <span id="charCount">0 caractères</span>
                <span id="wordCount">0 mots</span>
                <span id="sentenceCount">0 phrases</span>
                <span id="audioSize">0 KB</span>
            </div>
            <p class="example-text" id="loadExample">Charger un exemple de texte avec ponctuation</p>
        </section>

        <section class="controls-section">
            <h2>Paramètres de la voix</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="rate">Vitesse de parole</label>
                    <div class="slider-container">
                        <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="rateValue">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="pitch">Ton de la voix</label>
                    <div class="slider-container">
                        <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="pitchValue">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="volume">Volume</label>
                    <div class="slider-container">
                        <input type="range" id="volume" min="0" max="1" step="0.1" value="1">
                        <span class="value-display" id="volumeValue">1.0</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="voices-section">
            <h2>Sélectionnez une voix</h2>
            
            <!-- Voix du navigateur (affiché par défaut) -->
            <div id="browserVoices">
                <p id="voicesLoading">Chargement des voix disponibles...</p>
                <div class="voices-container" id="voicesContainer">
                    <!-- Les options de voix du navigateur seront ajoutées dynamiquement -->
                </div>
            </div>
            
            <!-- Voix VoiceRSS (caché par défaut) -->
            <div id="voiceRSSVoices" class="hidden">
                <p>Choisissez une voix VoiceRSS pour la synthèse vocale :</p>
                <div class="voice-rss-selector" id="voiceRSSContainer">
                    <!-- Les options de voix VoiceRSS seront ajoutées dynamiquement -->
                </div>
                <div class="service-info" id="voiceRSSInfo">
                    <strong>VoiceRSS :</strong> 350 requêtes gratuites par jour. Les voix masculines peuvent nécessiter un plan payant.
                </div>
            </div>
            
            <!-- Voix TTSMaker (caché par défaut) -->
            <div id="ttsMakerVoices" class="hidden">
                <p>Choisissez une voix TTSMaker (gratuit avec des voix masculines) :</p>
                <div class="ttsmaker-voices" id="ttsMakerContainer">
                    <!-- Les options de voix TTSMaker seront ajoutées dynamiquement -->
                </div>
                <div class="service-info">
                    <strong>TTSMaker :</strong> 10 000 caractères gratuits par mois. Pas de clé API nécessaire pour l'usage basique. Voix masculines disponibles.
                </div>
            </div>
        </section>

        <div class="buttons">
            <button id="playBtn" class="play-btn">
                <span>▶ Lire le texte</span>
            </button>
            <button id="pauseBtn" class="pause-btn" disabled>
                <span>⏸ Pause</span>
            </button>
            <button id="resumeBtn" class="pause-btn" disabled>
                <span>▶ Reprendre</span>
            </button>
            <button id="stopBtn" class="stop-btn" disabled>
                <span>⏹ Arrêter</span>
            </button>
            <button id="downloadBtn" class="download-btn" disabled>
                <span>⬇ Télécharger MP3</span>
            </button>
            <button id="resetBtn" class="reset-btn">
                <span>↺ Réinitialiser</span>
            </button>
        </div>

        <div class="status ready" id="status">
            Prêt à convertir le texte en voix
        </div>

        <div id="apiMessage"></div>

        <div class="instructions">
            <h3>Instructions d'utilisation</h3>
            <ul>
                <li><strong>Étape 1 :</strong> Choisissez entre Moteur Navigateur (gratuit), VoiceRSS (350 requêtes/jour), ou TTSMaker (10 000 caractères/mois)</li>
                <li><strong>Étape 2 :</strong> Saisissez ou collez votre texte dans la zone de texte</li>
                <li><strong>Étape 3 :</strong> Ajustez les paramètres (vitesse, ton, volume) selon vos préférences</li>
                <li><strong>Étape 4 :</strong> Sélectionnez une voix parmi celles disponibles</li>
                <li><strong>Étape 5 :</strong> Cliquez sur "Lire le texte" pour démarrer la synthèse vocale</li>
                <li><strong>Étape 6 :</strong> Utilisez "Télécharger MP3" pour sauvegarder (VoiceRSS et TTSMaker seulement)</li>
                <li><strong>Astuce :</strong> TTSMaker offre des voix masculines gratuites sans clé API nécessaire</li>
            </ul>
        </div>
    </div>

    <footer>
        <p>Outil de synthèse vocale avec support VoiceRSS & TTSMaker - Compatible avec les navigateurs modernes</p>
    </footer>

    <script>
        // Éléments DOM
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const sentenceCount = document.getElementById('sentenceCount');
        const audioSize = document.getElementById('audioSize');
        const rateSlider = document.getElementById('rate');
        const rateValue = document.getElementById('rateValue');
        const pitchSlider = document.getElementById('pitch');
        const pitchValue = document.getElementById('pitchValue');
        const volumeSlider = document.getElementById('volume');
        const volumeValue = document.getElementById('volumeValue');
        const voicesContainer = document.getElementById('voicesContainer');
        const voiceRSSContainer = document.getElementById('voiceRSSContainer');
        const ttsMakerContainer = document.getElementById('ttsMakerContainer');
        const voicesLoading = document.getElementById('voicesLoading');
        const browserVoices = document.getElementById('browserVoices');
        const voiceRSSVoices = document.getElementById('voiceRSSVoices');
        const ttsMakerVoices = document.getElementById('ttsMakerVoices');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const status = document.getElementById('status');
        const loadExample = document.getElementById('loadExample');
        const apiKeyInput = document.getElementById('apiKey');
        const ttsMakerKeyInput = document.getElementById('ttsMakerKey');
        const voiceRSSConfig = document.getElementById('voiceRSSConfig');
        const ttsMakerConfig = document.getElementById('ttsMakerConfig');
        const engineBrowser = document.getElementById('engineBrowser');
        const engineVoiceRSS = document.getElementById('engineVoiceRSS');
        const engineTTSMaker = document.getElementById('engineTTSMaker');
        const apiMessage = document.getElementById('apiMessage');
        const voiceRSSInfo = document.getElementById('voiceRSSInfo');

        // Variables globales
        let synth = window.speechSynthesis;
        let voices = [];
        let selectedVoice = null;
        let selectedVoiceRSS = null;
        let selectedTTSMakerVoice = null;
        let isPlaying = false;
        let isPaused = false;
        let currentUtterance = null;
        let audioBlob = null;
        let audioUrl = null;
        let currentEngine = 'browser'; // 'browser', 'voicerss', ou 'ttsmaker'
        let audioElement = null;
        let currentService = 'voicerss'; // 'voicerss' ou 'ttsmaker' pour les services externes

        // Liste des voix VoiceRSS disponibles
        const voiceRSSVoicesList = [
            // Voix françaises (certaines peuvent être dans le plan gratuit)
            { code: 'Alice', name: 'Alice', language: 'Français', country: 'France', gender: 'Femme', langCode: 'fr-fr' },
            { code: 'Julie', name: 'Julie', language: 'Français', country: 'France', gender: 'Femme', langCode: 'fr-fr' },
            { code: 'Mathieu', name: 'Mathieu', language: 'Français', country: 'France', gender: 'Homme', langCode: 'fr-fr' },
            { code: 'Louis', name: 'Louis', language: 'Français', country: 'France', gender: 'Homme', langCode: 'fr-fr' },
            { code: 'Paul', name: 'Paul', language: 'Français', country: 'France', gender: 'Homme', langCode: 'fr-fr' },
            
            // Voix anglaises
            { code: 'Samantha', name: 'Samantha', language: 'Anglais', country: 'États-Unis', gender: 'Femme', langCode: 'en-us' },
            { code: 'Daniel', name: 'Daniel', language: 'Anglais', country: 'Royaume-Uni', gender: 'Homme', langCode: 'en-gb' },
        ];

        // Liste des voix TTSMaker disponibles (gratuites avec voix masculines)
        const ttsMakerVoicesList = [
            // Voix masculines françaises
            { id: 'fr_fr_male', name: 'Français Homme 1', language: 'Français', gender: 'Homme', code: 'fr_fr_male' },
            { id: 'fr_fr_male_2', name: 'Français Homme 2', language: 'Français', gender: 'Homme', code: 'fr_fr_male_2' },
            { id: 'fr_fr_male_3', name: 'Français Homme 3', language: 'Français', gender: 'Homme', code: 'fr_fr_male_3' },
            
            // Voix féminines françaises
            { id: 'fr_fr_female', name: 'Français Femme 1', language: 'Français', gender: 'Femme', code: 'fr_fr_female' },
            { id: 'fr_fr_female_2', name: 'Français Femme 2', language: 'Français', gender: 'Femme', code: 'fr_fr_female_2' },
            
            // Voix anglaises
            { id: 'en_us_male', name: 'Anglais Homme (US)', language: 'Anglais', gender: 'Homme', code: 'en_us_male' },
            { id: 'en_us_female', name: 'Anglais Femme (US)', language: 'Anglais', gender: 'Femme', code: 'en_us_female' },
            { id: 'en_gb_male', name: 'Anglais Homme (GB)', language: 'Anglais', gender: 'Homme', code: 'en_gb_male' },
            { id: 'en_gb_female', name: 'Anglais Femme (GB)', language: 'Anglais', gender: 'Femme', code: 'en_gb_female' },
        ];

        // Configuration des moteurs
        engineBrowser.addEventListener('click', () => {
            setEngine('browser');
        });

        engineVoiceRSS.addEventListener('click', () => {
            setEngine('voicerss');
        });

        engineTTSMaker.addEventListener('click', () => {
            setEngine('ttsmaker');
        });

        function setEngine(engine) {
            // Mettre à jour les classes selected
            engineBrowser.classList.remove('selected');
            engineVoiceRSS.classList.remove('selected');
            engineTTSMaker.classList.remove('selected');
            
            // Masquer toutes les configurations et sélections de voix
            voiceRSSConfig.classList.add('hidden');
            ttsMakerConfig.classList.add('hidden');
            browserVoices.classList.add('hidden');
            voiceRSSVoices.classList.add('hidden');
            ttsMakerVoices.classList.add('hidden');
            
            // Réinitialiser l'audio en cours
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
            }
            
            isPlaying = false;
            isPaused = false;
            currentEngine = engine;
            
            // Configurer selon l'engine choisi
            if (engine === 'browser') {
                engineBrowser.classList.add('selected');
                browserVoices.classList.remove('hidden');
                status.textContent = 'Moteur navigateur activé';
                downloadBtn.disabled = true; // Pas de téléchargement avec le navigateur
            } else if (engine === 'voicerss') {
                engineVoiceRSS.classList.add('selected');
                voiceRSSConfig.classList.remove('hidden');
                voiceRSSVoices.classList.remove('hidden');
                status.textContent = 'VoiceRSS activé';
                currentService = 'voicerss';
            } else if (engine === 'ttsmaker') {
                engineTTSMaker.classList.add('selected');
                ttsMakerConfig.classList.remove('hidden');
                ttsMakerVoices.classList.remove('hidden');
                status.textContent = 'TTSMaker activé (voix masculines disponibles)';
                currentService = 'ttsmaker';
            }
            
            status.className = 'status ready';
            clearApiMessage();
            updateButtons();
        }

        // Fonction pour afficher les messages API
        function showApiMessage(message, type = 'error') {
            clearApiMessage();
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : type === 'warning' ? 'warning-message' : 'success-message';
            messageDiv.textContent = message;
            apiMessage.appendChild(messageDiv);
        }

        function clearApiMessage() {
            apiMessage.innerHTML = '';
        }

        // Mettre à jour les statistiques du texte
        function updateTextStats() {
            const text = textInput.value;
            const charCountValue = text.length;
            const wordCountValue = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const sentenceCountValue = sentences.length;
            
            const estimatedAudioSize = Math.round(charCountValue * 0.05);
            
            charCount.textContent = `${charCountValue} caractères`;
            wordCount.textContent = `${wordCountValue} mots`;
            sentenceCount.textContent = `${sentenceCountValue} phrases`;
            audioSize.textContent = `${estimatedAudioSize} KB estimés`;
        }

        // Mettre à jour l'affichage des valeurs des sliders
        rateSlider.addEventListener('input', () => {
            rateValue.textContent = rateSlider.value;
        });

        pitchSlider.addEventListener('input', () => {
            pitchValue.textContent = pitchSlider.value;
        });

        volumeSlider.addEventListener('input', () => {
            volumeValue.textContent = volumeSlider.value;
        });

        // Charger les voix disponibles pour le navigateur
        function loadVoices() {
            voices = synth.getVoices();
            voicesLoading.style.display = 'none';
            voicesContainer.innerHTML = '';
            
            const frenchVoices = voices.filter(voice => 
                voice.lang.startsWith('fr') || 
                voice.lang.startsWith('en') || 
                voice.name.toLowerCase().includes('french')
            );
            
            const voicesToShow = frenchVoices.length > 0 ? frenchVoices : voices;
            
            if (voicesToShow.length === 0) {
                voicesContainer.innerHTML = '<p>Aucune voix disponible. Votre navigateur peut ne pas supporter la synthèse vocale.</p>';
                return;
            }
            
            voicesToShow.sort((a, b) => {
                if (a.lang < b.lang) return -1;
                if (a.lang > b.lang) return 1;
                return 0;
            });
            
            voicesToShow.forEach((voice, index) => {
                const voiceOption = document.createElement('div');
                voiceOption.className = 'voice-option';
                if (index === 0) {
                    voiceOption.classList.add('selected');
                    selectedVoice = voice;
                }
                
                const gender = voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('femme') ? 'Femme' : 'Homme';
                
                voiceOption.innerHTML = `
                    <div class="voice-name">${voice.name}</div>
                    <div class="voice-details">
                        <span class="voice-lang">${voice.lang}</span>
                        <span class="voice-gender ${gender === 'Femme' ? 'female' : 'male'}">${gender}</span>
                    </div>
                `;
                
                voiceOption.addEventListener('click', () => {
                    document.querySelectorAll('.voice-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    
                    voiceOption.classList.add('selected');
                    selectedVoice = voice;
                });
                
                voicesContainer.appendChild(voiceOption);
            });
        }

        // Charger les voix VoiceRSS
        function loadVoiceRSSVoices() {
            voiceRSSContainer.innerHTML = '';
            
            // Séparer les voix par genre pour faciliter la sélection
            const maleVoices = voiceRSSVoicesList.filter(voice => voice.gender === 'Homme');
            const femaleVoices = voiceRSSVoicesList.filter(voice => voice.gender === 'Femme');
            
            // Ajouter les voix masculines
            if (maleVoices.length > 0) {
                const maleHeader = document.createElement('div');
                maleHeader.innerHTML = '<h4 style="margin-top: 15px; color: #3498db;">Voix Masculines (peut nécessiter un plan payant)</h4>';
                voiceRSSContainer.appendChild(maleHeader);
                
                maleVoices.forEach((voice, index) => {
                    const voiceOption = createVoiceRSSOption(voice, index === 0 && !selectedVoiceRSS);
                    voiceRSSContainer.appendChild(voiceOption);
                });
            }
            
            // Ajouter les voix féminines
            if (femaleVoices.length > 0) {
                const femaleHeader = document.createElement('div');
                femaleHeader.innerHTML = '<h4 style="margin-top: 15px; color: #e74c3c;">Voix Féminines (généralement disponibles en gratuit)</h4>';
                voiceRSSContainer.appendChild(femaleHeader);
                
                femaleVoices.forEach((voice, index) => {
                    const voiceOption = createVoiceRSSOption(voice, index === 0 && !selectedVoiceRSS);
                    voiceRSSContainer.appendChild(voiceOption);
                });
            }
            
            // Sélectionner la première voix si aucune n'est sélectionnée
            if (!selectedVoiceRSS && voiceRSSVoicesList.length > 0) {
                selectedVoiceRSS = voiceRSSVoicesList[0];
                const firstOption = voiceRSSContainer.querySelector('.voice-rss-option');
                if (firstOption) firstOption.classList.add('selected');
            }
        }

        function createVoiceRSSOption(voice, isSelected = false) {
            const voiceOption = document.createElement('div');
            voiceOption.className = 'voice-rss-option';
            
            if (isSelected) {
                voiceOption.classList.add('selected');
            }
            
            voiceOption.innerHTML = `
                <div class="voice-rss-name">${voice.name}</div>
                <div class="voice-rss-details">
                    <span>${voice.language} (${voice.country})</span>
                    <span class="voice-gender ${voice.gender === 'Femme' ? 'female' : 'male'}">${voice.gender}</span>
                </div>
            `;
            
            voiceOption.addEventListener('click', () => {
                document.querySelectorAll('.voice-rss-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                voiceOption.classList.add('selected');
                selectedVoiceRSS = voice;
            });
            
            return voiceOption;
        }

        // Charger les voix TTSMaker
        function loadTTSMakerVoices() {
            ttsMakerContainer.innerHTML = '';
            
            // Séparer les voix par langue
            const frenchVoices = ttsMakerVoicesList.filter(voice => voice.language === 'Français');
            const englishVoices = ttsMakerVoicesList.filter(voice => voice.language === 'Anglais');
            
            // Ajouter les voix françaises
            if (frenchVoices.length > 0) {
                const frenchHeader = document.createElement('div');
                frenchHeader.innerHTML = '<h4 style="margin-top: 15px;">Voix Françaises</h4>';
                frenchHeader.style.gridColumn = '1 / -1';
                ttsMakerContainer.appendChild(frenchHeader);
                
                frenchVoices.forEach((voice, index) => {
                    const voiceOption = createTTSMakerOption(voice, index === 0 && !selectedTTSMakerVoice);
                    ttsMakerContainer.appendChild(voiceOption);
                });
            }
            
            // Ajouter les voix anglaises
            if (englishVoices.length > 0) {
                const englishHeader = document.createElement('div');
                englishHeader.innerHTML = '<h4 style="margin-top: 15px;">Voix Anglaises</h4>';
                englishHeader.style.gridColumn = '1 / -1';
                ttsMakerContainer.appendChild(englishHeader);
                
                englishVoices.forEach((voice, index) => {
                    const voiceOption = createTTSMakerOption(voice, index === 0 && !selectedTTSMakerVoice);
                    ttsMakerContainer.appendChild(voiceOption);
                });
            }
            
            // Sélectionner la première voix si aucune n'est sélectionnée
            if (!selectedTTSMakerVoice && ttsMakerVoicesList.length > 0) {
                selectedTTSMakerVoice = ttsMakerVoicesList[0];
                const firstOption = ttsMakerContainer.querySelector('.ttsmaker-voice');
                if (firstOption) firstOption.classList.add('selected');
            }
        }

        function createTTSMakerOption(voice, isSelected = false) {
            const voiceOption = document.createElement('div');
            voiceOption.className = 'ttsmaker-voice';
            
            if (isSelected) {
                voiceOption.classList.add('selected');
            }
            
            voiceOption.innerHTML = `
                <div class="ttsmaker-voice-name">${voice.name}</div>
                <div class="voice-rss-details">
                    <span>${voice.language}</span>
                    <span class="voice-gender ${voice.gender === 'Femme' ? 'female' : 'male'}">${voice.gender}</span>
                </div>
            `;
            
            voiceOption.addEventListener('click', () => {
                document.querySelectorAll('.ttsmaker-voice').forEach(option => {
                    option.classList.remove('selected');
                });
                
                voiceOption.classList.add('selected');
                selectedTTSMakerVoice = voice;
            });
            
            return voiceOption;
        }

        // Initialiser les voix du navigateur
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }

        // Charger les voix au démarrage
        loadVoices();
        loadVoiceRSSVoices();
        loadTTSMakerVoices();

        // Mettre à jour les stats du texte au chargement et à chaque modification
        textInput.addEventListener('input', updateTextStats);
        updateTextStats();

        // Utiliser VoiceRSS pour la synthèse vocale avec fallback
        async function speakWithVoiceRSS() {
            const text = textInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                showApiMessage('Veuillez entrer votre clé API VoiceRSS.');
                return;
            }
            
            if (text === '') {
                showApiMessage('Veuillez saisir du texte à lire.');
                return;
            }
            
            if (!selectedVoiceRSS) {
                showApiMessage('Veuillez sélectionner une voix VoiceRSS.');
                return;
            }
            
            if (text.length > 5000) {
                showApiMessage('Le texte est trop long pour VoiceRSS gratuit (limite: 5000 caractères). Réduisez le texte.');
                return;
            }
            
            playBtn.disabled = true;
            status.textContent = `Essai avec ${selectedVoiceRSS.name}...`;
            status.className = 'status processing';
            clearApiMessage();
            
            try {
                // Essayer avec la voix sélectionnée
                const params = new URLSearchParams({
                    key: apiKey,
                    src: text,
                    hl: selectedVoiceRSS.langCode,
                    v: selectedVoiceRSS.code,
                    r: rateSlider.value,
                    c: 'MP3',
                    f: '44khz_16bit_stereo',
                    ssml: 'false'
                });
                
                const response = await fetch(`https://api.voicerss.org/?${params.toString()}`);
                const responseText = await response.text();
                
                // Vérifier si c'est une erreur de voix non disponible
                if (responseText.startsWith('ERROR') && responseText.includes('voice')) {
                    // La voix n'est pas disponible, essayer avec une voix féminine par défaut
                    showApiMessage(`La voix ${selectedVoiceRSS.name} n'est pas disponible dans votre plan. Essai avec Alice...`, 'warning');
                    
                    // Essayer avec Alice (voix féminine gratuite)
                    const fallbackParams = new URLSearchParams({
                        key: apiKey,
                        src: text,
                        hl: 'fr-fr',
                        v: 'Alice',
                        r: rateSlider.value,
                        c: 'MP3',
                        f: '44khz_16bit_stereo',
                        ssml: 'false'
                    });
                    
                    const fallbackResponse = await fetch(`https://api.voicerss.org/?${fallbackParams.toString()}`);
                    const fallbackText = await fallbackResponse.text();
                    
                    if (fallbackText.startsWith('ERROR')) {
                        throw new Error(`VoiceRSS: ${fallbackText}. Essayez TTSMaker pour les voix masculines.`);
                    }
                    
                    const audioData = await fallbackResponse.blob();
                    processAudioData(audioData, 'Alice (fallback)');
                    
                } else if (responseText.startsWith('ERROR')) {
                    // Autre erreur
                    throw new Error(`VoiceRSS: ${responseText}`);
                } else {
                    // Succès avec la voix sélectionnée
                    const audioData = await response.blob();
                    processAudioData(audioData, selectedVoiceRSS.name);
                }
                
            } catch (error) {
                console.error('Erreur VoiceRSS:', error);
                
                if (error.message.includes('VoiceRSS:')) {
                    showApiMessage(`Erreur VoiceRSS: ${error.message.replace('VoiceRSS: ', '')}. Essayez TTSMaker pour les voix masculines.`, 'warning');
                } else {
                    showApiMessage(`Erreur: ${error.message}`, 'error');
                }
                
                status.textContent = 'Échec avec VoiceRSS';
                status.className = 'status stopped';
                playBtn.disabled = false;
                downloadBtn.disabled = true;
            }
        }

        // Utiliser TTSMaker pour la synthèse vocale
        async function speakWithTTSMaker() {
            const text = textInput.value.trim();
            
            if (text === '') {
                showApiMessage('Veuillez saisir du texte à lire.');
                return;
            }
            
            if (!selectedTTSMakerVoice) {
                showApiMessage('Veuillez sélectionner une voix TTSMaker.');
                return;
            }
            
            // Limite TTSMaker gratuit : 10 000 caractères
            if (text.length > 10000) {
                showApiMessage('Le texte est trop long pour TTSMaker gratuit (limite: 10 000 caractères). Réduisez le texte.');
                return;
            }
            
            playBtn.disabled = true;
            status.textContent = `Génération avec ${selectedTTSMakerVoice.name}...`;
            status.className = 'status processing';
            clearApiMessage();
            
            try {
                // TTSMaker ne nécessite pas de clé API pour l'usage basique
                // Nous allons utiliser leur API via un proxy CORS pour contourner les restrictions
                const apiKey = ttsMakerKeyInput.value.trim();
                
                // Paramètres pour TTSMaker
                const formData = new FormData();
                formData.append('text', text);
                formData.append('voice_id', selectedTTSMakerVoice.code);
                formData.append('speed', rateSlider.value);
                formData.append('format', 'mp3');
                
                if (apiKey) {
                    formData.append('api_key', apiKey);
                }
                
                // Utiliser un proxy CORS pour éviter les problèmes
                const proxyUrl = 'https://corsproxy.io/?';
                const ttsMakerUrl = 'https://api.ttsmaker.com/v1/create-tts-order';
                
                const response = await fetch(proxyUrl + encodeURIComponent(ttsMakerUrl), {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur TTSMaker: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Télécharger le fichier audio
                    const audioResponse = await fetch(proxyUrl + encodeURIComponent(result.audio_file_url));
                    const audioData = await audioResponse.blob();
                    
                    processAudioData(audioData, selectedTTSMakerVoice.name);
                    
                    showApiMessage(`Audio généré avec ${selectedTTSMakerVoice.name} ! Téléchargement disponible.`, 'success');
                } else {
                    throw new Error(`TTSMaker: ${result.message || 'Erreur inconnue'}`);
                }
                
            } catch (error) {
                console.error('Erreur TTSMaker:', error);
                
                // Fallback: Essayer avec une méthode alternative si TTSMaker échoue
                showApiMessage(`TTSMaker: ${error.message}. Essai avec une méthode alternative...`, 'warning');
                
                // Méthode alternative: Utiliser un service TTS public gratuit
                try {
                    await useAlternativeTTSService(text);
                } catch (fallbackError) {
                    showApiMessage(`Échec complet. Essayez VoiceRSS ou le moteur navigateur.`, 'error');
                    status.textContent = 'Échec de génération audio';
                    status.className = 'status stopped';
                    playBtn.disabled = false;
                    downloadBtn.disabled = true;
                }
            }
        }

        // Méthode alternative de synthèse vocale (fallback)
        async function useAlternativeTTSService(text) {
            // Utiliser un service TTS public gratuit (ex: Google Translate TTS)
            // Note: Cette méthode peut ne pas fonctionner à cause des restrictions CORS
            const encodedText = encodeURIComponent(text.substring(0, 200)); // Limiter la longueur
            const lang = selectedTTSMakerVoice && selectedTTSMakerVoice.code.includes('fr') ? 'fr' : 'en';
            
            const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=${lang}&q=${encodedText}`;
            
            const response = await fetch(ttsUrl);
            const audioData = await response.blob();
            
            processAudioData(audioData, 'Service alternatif');
            showApiMessage('Audio généré avec un service alternatif (qualité limitée).', 'warning');
        }

        // Traiter les données audio (commun pour tous les services)
        function processAudioData(audioData, voiceName) {
            audioBlob = audioData;
            
            if (audioUrl) {
                URL.revokeObjectURL(audioUrl);
            }
            audioUrl = URL.createObjectURL(audioBlob);
            
            if (!audioElement) {
                audioElement = new Audio();
            }
            
            audioElement.src = audioUrl;
            audioElement.volume = parseFloat(volumeSlider.value);
            
            audioElement.onplay = () => {
                isPlaying = true;
                isPaused = false;
                updateButtons();
                status.textContent = `Lecture avec ${voiceName}...`;
                status.className = 'status speaking';
            };
            
            audioElement.onpause = () => {
                isPaused = true;
                updateButtons();
                status.textContent = 'Lecture en pause';
                status.className = 'status paused';
            };
            
            audioElement.onended = () => {
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture terminée - Prêt à télécharger';
                status.className = 'status ready';
            };
            
            audioElement.onerror = (error) => {
                console.error('Erreur audio:', error);
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Erreur lors de la lecture audio';
                status.className = 'status stopped';
                playBtn.disabled = false;
                showApiMessage('Erreur lors de la lecture audio.', 'error');
            };
            
            downloadBtn.disabled = false;
            audioElement.play().then(() => {
                playBtn.disabled = false;
            }).catch(error => {
                console.error('Erreur de lecture:', error);
                playBtn.disabled = false;
                showApiMessage('Impossible de lire l\'audio. Téléchargement toujours disponible.', 'warning');
            });
        }

        // Utiliser la synthèse vocale du navigateur
        function speakWithBrowser() {
            const text = textInput.value.trim();
            if (text === '') {
                showApiMessage('Veuillez saisir du texte à lire.');
                return;
            }
            
            if (!selectedVoice) {
                showApiMessage('Aucune voix sélectionnée. Veuillez choisir une voix.');
                return;
            }
            
            if (currentUtterance) {
                synth.cancel();
            }
            
            downloadBtn.disabled = true;
            clearApiMessage();
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            currentUtterance.voice = selectedVoice;
            currentUtterance.rate = parseFloat(rateSlider.value);
            currentUtterance.pitch = parseFloat(pitchSlider.value);
            currentUtterance.volume = parseFloat(volumeSlider.value);
            
            currentUtterance.onstart = () => {
                isPlaying = true;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture en cours...';
                status.className = 'status speaking';
            };
            
            currentUtterance.onend = () => {
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture terminée';
                status.className = 'status ready';
            };
            
            currentUtterance.onerror = (event) => {
                console.error('Erreur de synthèse vocale:', event);
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Erreur lors de la lecture';
                status.className = 'status stopped';
                showApiMessage('Erreur lors de la synthèse vocale du navigateur.');
            };
            
            currentUtterance.onpause = () => {
                isPaused = true;
                updateButtons();
                status.textContent = 'Lecture en pause';
                status.className = 'status paused';
            };
            
            currentUtterance.onresume = () => {
                isPaused = false;
                updateButtons();
                status.textContent = 'Reprise de la lecture';
                status.className = 'status speaking';
            };
            
            synth.speak(currentUtterance);
        }

        // Gérer la lecture du texte
        playBtn.addEventListener('click', () => {
            if (isPlaying && !isPaused) {
                return;
            }
            
            if (currentEngine === 'voicerss') {
                speakWithVoiceRSS();
            } else if (currentEngine === 'ttsmaker') {
                speakWithTTSMaker();
            } else {
                speakWithBrowser();
            }
        });

        // Gérer la pause
        pauseBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss' || currentEngine === 'ttsmaker') {
                if (audioElement && isPlaying && !isPaused) {
                    audioElement.pause();
                    isPaused = true;
                    updateButtons();
                    status.textContent = 'Lecture en pause';
                    status.className = 'status paused';
                }
            } else {
                if (isPlaying && !isPaused) {
                    synth.pause();
                    isPaused = true;
                    updateButtons();
                    status.textContent = 'Lecture en pause';
                    status.className = 'status paused';
                }
            }
        });

        // Gérer la reprise
        resumeBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss' || currentEngine === 'ttsmaker') {
                if (audioElement && isPlaying && isPaused) {
                    audioElement.play();
                    isPaused = false;
                    updateButtons();
                    status.textContent = 'Reprise de la lecture';
                    status.className = 'status speaking';
                }
            } else {
                if (isPlaying && isPaused) {
                    synth.resume();
                    isPaused = false;
                    updateButtons();
                    status.textContent = 'Reprise de la lecture';
                    status.className = 'status speaking';
                }
            }
        });

        // Gérer l'arrêt
        stopBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss' || currentEngine === 'ttsmaker') {
                if (audioElement) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                }
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture arrêtée';
                status.className = 'status stopped';
            } else {
                synth.cancel();
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture arrêtée';
                status.className = 'status stopped';
            }
        });

        // Gérer le téléchargement
        downloadBtn.addEventListener('click', function() {
            if (!audioBlob) {
                showApiMessage('Aucun fichier audio à télécharger. Veuillez d\'abord générer l\'audio.');
                return;
            }
            
            // Créer un nom de fichier basé sur le contenu et la voix
            const text = textInput.value.trim();
            let voiceName = 'voix';
            
            if (currentEngine === 'voicerss' && selectedVoiceRSS) {
                voiceName = selectedVoiceRSS.name;
            } else if (currentEngine === 'ttsmaker' && selectedTTSMakerVoice) {
                voiceName = selectedTTSMakerVoice.name;
            }
            
            let fileName = 'audio_generé.mp3';
            
            if (text.length > 0) {
                const safeName = text.substring(0, 15)
                    .replace(/[^a-zA-Z0-9\u00C0-\u017F\s]/g, '')
                    .replace(/\s+/g, '_');
                fileName = `audio_${voiceName}_${safeName}_${Date.now()}.mp3`;
            } else {
                fileName = `audio_${voiceName}_${Date.now()}.mp3`;
            }
            
            // S'assurer que l'URL est valide
            let downloadUrl = audioUrl;
            if (!downloadUrl) {
                downloadUrl = URL.createObjectURL(audioBlob);
            }
            
            // Créer un lien de téléchargement
            const downloadLink = document.createElement('a');
            downloadLink.href = downloadUrl;
            downloadLink.download = fileName;
            
            // Ajouter au DOM, cliquer, et retirer
            document.body.appendChild(downloadLink);
            downloadLink.click();
            
            // Nettoyer après un court délai
            setTimeout(() => {
                document.body.removeChild(downloadLink);
            }, 100);
            
            showApiMessage(`Téléchargement démarré: ${fileName}`, 'success');
        });

        // Gérer la réinitialisation
        resetBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss' || currentEngine === 'ttsmaker') {
                if (audioElement) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                    audioElement.src = '';
                }
                if (audioUrl) {
                    URL.revokeObjectURL(audioUrl);
                    audioUrl = null;
                }
                audioBlob = null;
            } else {
                synth.cancel();
            }
            
            isPlaying = false;
            isPaused = false;
            
            rateSlider.value = 1;
            rateValue.textContent = '1.0';
            pitchSlider.value = 1;
            pitchValue.textContent = '1.0';
            volumeSlider.value = 1;
            volumeValue.textContent = '1.0';
            
            textInput.value = '';
            updateTextStats();
            
            // Réinitialiser la sélection de voix selon le moteur
            if (currentEngine === 'browser' && voices.length > 0) {
                document.querySelectorAll('.voice-option').forEach(option => {
                    option.classList.remove('selected');
                });
                const firstVoiceOption = document.querySelector('.voice-option');
                if (firstVoiceOption) {
                    firstVoiceOption.classList.add('selected');
                }
                selectedVoice = voices[0];
            } else if (currentEngine === 'voicerss') {
                document.querySelectorAll('.voice-rss-option').forEach(option => {
                    option.classList.remove('selected');
                });
                const firstVoiceRSSOption = document.querySelector('.voice-rss-option');
                if (firstVoiceRSSOption) {
                    firstVoiceRSSOption.classList.add('selected');
                }
                selectedVoiceRSS = voiceRSSVoicesList[0];
            } else if (currentEngine === 'ttsmaker') {
                document.querySelectorAll('.ttsmaker-voice').forEach(option => {
                    option.classList.remove('selected');
                });
                const firstTTSMakerOption = document.querySelector('.ttsmaker-voice');
                if (firstTTSMakerOption) {
                    firstTTSMakerOption.classList.add('selected');
                }
                selectedTTSMakerVoice = ttsMakerVoicesList[0];
            }
            
            downloadBtn.disabled = true;
            
            updateButtons();
            status.textContent = 'Prêt à convertir le texte en voix';
            status.className = 'status ready';
            clearApiMessage();
        });

        // Mettre à jour l'état des boutons
        function updateButtons() {
            const isExternalService = currentEngine === 'voicerss' || currentEngine === 'ttsmaker';
            
            playBtn.disabled = (isPlaying && !isPaused) || (currentEngine === 'voicerss' && !apiKeyInput.value.trim());
            pauseBtn.disabled = !isPlaying || isPaused;
            resumeBtn.disabled = !isPlaying || !isPaused;
            stopBtn.disabled = !isPlaying;
            
            if (isExternalService) {
                downloadBtn.disabled = !audioBlob || isPlaying;
            } else {
                downloadBtn.disabled = true;
            }
        }

        // Charger un exemple de texte
        loadExample.addEventListener('click', () => {
            textInput.value = `La synthèse vocale, ou text-to-speech (TTS), est une technologie qui convertit le texte en parole artificielle.

Cette technologie est utilisée dans de nombreux domaines : assistance aux personnes malvoyantes, navigation GPS, assistants vocaux, et bien plus encore.

Le respect de la ponctuation est essentiel pour une lecture naturelle. Par exemple, une virgule introduit une courte pause, un point une pause plus longue, et un point d'interrogation modifie l'intonation de la voix.

Avec VoiceRSS et TTSMaker, vous pouvez générer un fichier audio de haute qualité et le télécharger au format MP3 pour une utilisation hors ligne.

Essayez avec votre propre texte maintenant !`;
            updateTextStats();
            clearApiMessage();
        });

        // Mettre à jour l'état des boutons quand les clés API changent
        apiKeyInput.addEventListener('input', updateButtons);
        ttsMakerKeyInput.addEventListener('input', updateButtons);

        // Tester la clé API au chargement de la page
        window.addEventListener('load', () => {
            if (apiKeyInput.value.trim()) {
                showApiMessage('✅ Clé API VoiceRSS détectée. Essayez TTSMaker pour les voix masculines si VoiceRSS échoue.', 'success');
            }
            
            updateButtons();
        });

        // Initialiser l'état des boutons
        updateButtons();
    </script>
</body>
</html>
