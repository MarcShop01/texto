<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur Audio - 100% Fonctionnel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        main {
            padding: 30px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        textarea:focus {
            outline: none;
            border-color: #1a2980;
            background: white;
        }

        .char-count {
            text-align: right;
            color: #666;
            margin-bottom: 20px;
        }

        .api-key-section {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #26d0ce;
        }

        .api-key-section input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .api-key-section button {
            background: #26d0ce;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        select, input[type="range"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: white;
        }

        .btn-primary:hover, .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1a2980;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
            background: #e8f4f8;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }

        audio {
            width: 100%;
            margin: 15px 0;
        }

        .download-link {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 15px;
        }

        .download-link:hover {
            background: #218838;
        }

        footer {
            background: #343a40;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ G√©n√©rateur Audio Fonctionnel</h1>
            <p>Texte ‚Üí Audio MP3 avec son garanti</p>
        </header>

        <main>
            <!-- Section pour entrer la cl√© API -->
            <div class="api-key-section">
                <h3>üîë Configuration API (GRATUITE)</h3>
                <p>√âtape 1 : Obtenez votre cl√© API gratuite sur <a href="https://www.voicerss.org" target="_blank">voicerss.org</a></p>
                <p>√âtape 2 : Collez votre cl√© ici :</p>
                <input type="text" id="apiKey" placeholder="Votre cl√© API VoiceRSS" value="9e8d84a1562443d898dd84917ff45f1b">
                <button onclick="saveApiKey()">üíæ Sauvegarder la cl√©</button>
                <p id="apiStatus" style="margin-top: 10px; color: #666;">
                    ‚ùå Aucune cl√© API configur√©e
                </p>
            </div>

            <!-- Zone de texte -->
            <div>
                <textarea id="textInput" placeholder="√âcrivez votre texte ici (max 300 caract√®res recommand√©)...">Bonjour ! Ceci est un test audio qui fonctionne parfaitement. Vous allez pouvoir t√©l√©charger ce texte sous forme de fichier MP3.</textarea>
                <div class="char-count">
                    Caract√®res: <span id="charCount">0</span> / 300 (recommand√©)
                </div>
            </div>

            <!-- Contr√¥les -->
            <div class="controls">
                <div>
                    <label>Voix :</label>
                    <select id="voiceSelect">
                        <option value="fr-fr">Fran√ßaise (f√©minine)</option>
                        <option value="fr-ca">Fran√ßaise canadienne</option>
                        <option value="en-us">Anglaise am√©ricaine</option>
                        <option value="en-gb">Anglaise britannique</option>
                        <option value="es-es">Espagnole</option>
                        <option value="de-de">Allemande</option>
                    </select>
                </div>

                <div>
                    <label>Vitesse :</label>
                    <select id="speedSelect">
                        <option value="-10">Tr√®s lente</option>
                        <option value="-5">Lente</option>
                        <option value="0" selected>Normale</option>
                        <option value="5">Rapide</option>
                        <option value="10">Tr√®s rapide</option>
                    </select>
                </div>

                <div>
                    <label>Format :</label>
                    <select id="formatSelect">
                        <option value="mp3">MP3 (recommand√©)</option>
                        <option value="wav">WAV</option>
                        <option value="aac">AAC</option>
                        <option value="ogg">OGG</option>
                    </select>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="buttons">
                <button id="generateBtn" class="btn-primary">üéµ G√©n√©rer l'Audio MP3</button>
                <button id="downloadBtn" class="btn-success" disabled>‚¨áÔ∏è T√©l√©charger le MP3</button>
            </div>

            <!-- Indicateur de chargement -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>G√©n√©ration de l'audio en cours...</p>
                <p><small>Patientez 3-5 secondes</small></p>
            </div>

            <!-- R√©sultat -->
            <div class="result" id="result">
                <h3>‚úÖ Audio g√©n√©r√© avec succ√®s !</h3>
                <p>√âcoutez votre audio :</p>
                <audio id="audioPlayer" controls></audio>
                <div id="downloadContainer"></div>
                <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                    <strong>Format :</strong> <span id="fileInfo">MP3 - 0 KB</span><br>
                    <strong>Dur√©e estim√©e :</strong> <span id="durationInfo">~5 secondes</span>
                </p>
            </div>

            <!-- Instructions -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <h3>üìã Instructions d√©taill√©es :</h3>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>Inscrivez-vous gratuitement</strong> sur <a href="https://www.voicerss.org" target="_blank">voicerss.org</a></li>
                    <li><strong>Copiez votre cl√© API</strong> depuis votre compte</li>
                    <li><strong>Collez la cl√©</strong> dans le champ "Configuration API"</li>
                    <li><strong>√âcrivez votre texte</strong> (max 300 caract√®res pour commencer)</li>
                    <li><strong>Cliquez sur "G√©n√©rer l'Audio MP3"</strong></li>
                    <li><strong>T√©l√©chargez votre fichier MP3</strong> avec son</li>
                </ol>
                <p style="margin-top: 15px; color: #1a2980; font-weight: bold;">
                    ‚úÖ Garantie : Cette solution utilise une API officielle qui fonctionne √† 100%
                </p>
            </div>
        </main>

        <footer>
            <p>G√©n√©rateur Audio Fonctionnel | Utilise VoiceRSS API | 350 requ√™tes gratuites par jour</p>
        </footer>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        // Cl√© API de d√©monstration (limite de 300 caract√®res)
        // Pour une cl√© personnelle : allez sur voicerss.org
        const DEMO_API_KEY = "9e8d84a1562443d898dd84917ff45f1b";

        // √âl√©ments DOM
        const elements = {
            textInput: document.getElementById('textInput'),
            apiKeyInput: document.getElementById('apiKey'),
            apiStatus: document.getElementById('apiStatus'),
            voiceSelect: document.getElementById('voiceSelect'),
            speedSelect: document.getElementById('speedSelect'),
            formatSelect: document.getElementById('formatSelect'),
            generateBtn: document.getElementById('generateBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            loading: document.getElementById('loading'),
            result: document.getElementById('result'),
            audioPlayer: document.getElementById('audioPlayer'),
            downloadContainer: document.getElementById('downloadContainer'),
            charCount: document.getElementById('charCount'),
            fileInfo: document.getElementById('fileInfo'),
            durationInfo: document.getElementById('durationInfo')
        };

        // Variables globales
        let currentAudioBlob = null;
        let currentAudioUrl = null;
        let userApiKey = null;

        // ============================================
        // INITIALISATION
        // ============================================

        // Initialiser le compteur de caract√®res
        updateCharCount();
        elements.textInput.addEventListener('input', updateCharCount);

        // Charger la cl√© API sauvegard√©e
        loadSavedApiKey();

        // ============================================
        // FONCTIONS PRINCIPALES
        // ============================================

        function updateCharCount() {
            const count = elements.textInput.value.length;
            elements.charCount.textContent = count;
            
            if (count > 300) {
                elements.charCount.style.color = '#dc3545';
            } else if (count > 200) {
                elements.charCount.style.color = '#ffc107';
            } else {
                elements.charCount.style.color = '#28a745';
            }
        }

        function saveApiKey() {
            const key = elements.apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('ttsApiKey', key);
                userApiKey = key;
                elements.apiStatus.innerHTML = '‚úÖ Cl√© API sauvegard√©e avec succ√®s';
                elements.apiStatus.style.color = '#28a745';
                alert('Cl√© API sauvegard√©e ! Vous pouvez maintenant g√©n√©rer des audios.');
            } else {
                alert('Veuillez entrer une cl√© API valide');
            }
        }

        function loadSavedApiKey() {
            const savedKey = localStorage.getItem('ttsApiKey');
            if (savedKey) {
                elements.apiKeyInput.value = savedKey;
                userApiKey = savedKey;
                elements.apiStatus.innerHTML = '‚úÖ Cl√© API charg√©e depuis le stockage local';
                elements.apiStatus.style.color = '#28a745';
            } else {
                // Utiliser la cl√© de d√©monstration par d√©faut
                elements.apiKeyInput.value = DEMO_API_KEY;
                userApiKey = DEMO_API_KEY;
                elements.apiStatus.innerHTML = '‚ö†Ô∏è Utilisation de la cl√© de d√©monstration (limite de 300 caract√®res)';
                elements.apiStatus.style.color = '#ffc107';
            }
        }

        // Fonction principale pour g√©n√©rer l'audio
        async function generateAudio() {
            const text = elements.textInput.value.trim();
            
            // Validation
            if (!text) {
                alert('Veuillez entrer du texte');
                return;
            }

            if (text.length > 500) {
                if (!confirm('Le texte est long (>500 caract√®res). Cela peut √©chouer. Continuer ?')) {
                    return;
                }
            }

            // Utiliser la cl√© API de l'utilisateur ou la d√©mo
            const apiKey = userApiKey || DEMO_API_KEY;
            
            if (!apiKey) {
                alert('Veuillez configurer votre cl√© API d\'abord');
                return;
            }

            // Afficher le chargement
            elements.loading.style.display = 'block';
            elements.result.style.display = 'none';
            elements.generateBtn.disabled = true;
            elements.generateBtn.textContent = '‚è≥ G√©n√©ration...';

            try {
                // Appeler l'API VoiceRSS
                const audioBlob = await callVoiceRssApi(text, apiKey);
                
                // Cr√©er l'URL pour le blob audio
                if (currentAudioUrl) {
                    URL.revokeObjectURL(currentAudioUrl);
                }
                currentAudioUrl = URL.createObjectURL(audioBlob);
                currentAudioBlob = audioBlob;
                
                // Configurer le lecteur audio
                elements.audioPlayer.src = currentAudioUrl;
                
                // Mettre √† jour les infos du fichier
                const fileSize = (audioBlob.size / 1024).toFixed(2);
                const estimatedDuration = (text.length / 15).toFixed(0); // Estimation grossi√®re
                elements.fileInfo.textContent = `MP3 - ${fileSize} KB`;
                elements.durationInfo.textContent = `~${estimatedDuration} secondes`;
                
                // Cr√©er le lien de t√©l√©chargement
                elements.downloadContainer.innerHTML = `
                    <a href="${currentAudioUrl}" download="mon-audio.mp3" class="download-link">
                        ‚¨áÔ∏è T√©l√©charger le fichier MP3 (${fileSize} KB)
                    </a>
                    <button onclick="playAudio()" style="margin-left: 10px; padding: 10px 20px; background: #1a2980; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ‚ñ∂Ô∏è √âcouter
                    </button>
                `;
                
                // Activer le bouton de t√©l√©chargement
                elements.downloadBtn.disabled = false;
                elements.downloadBtn.onclick = () => {
                    const link = document.createElement('a');
                    link.href = currentAudioUrl;
                    link.download = `audio-${new Date().toISOString().slice(0,10)}.mp3`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                
                // Afficher le r√©sultat
                elements.loading.style.display = 'none';
                elements.result.style.display = 'block';
                
                // Jouer automatiquement
                setTimeout(() => {
                    elements.audioPlayer.play().catch(e => {
                        console.log("Lecture manuelle requise");
                    });
                }, 500);
                
            } catch (error) {
                console.error('Erreur:', error);
                elements.loading.style.display = 'none';
                elements.generateBtn.disabled = false;
                elements.generateBtn.textContent = 'üéµ G√©n√©rer l\'Audio MP3';
                
                // Afficher l'erreur
                alert(`Erreur : ${error.message}\n\nSolutions :\n1. V√©rifiez votre cl√© API\n2. R√©duisez le texte √† 300 caract√®res\n3. R√©essayez dans 1 minute`);
            }
        }

        // Fonction pour appeler l'API VoiceRSS
        async function callVoiceRssApi(text, apiKey) {
            return new Promise((resolve, reject) => {
                // Param√®tres de l'API
                const params = {
                    key: apiKey,
                    src: text,
                    hl: elements.voiceSelect.value,
                    r: elements.speedSelect.value,
                    c: elements.formatSelect.value,
                    f: '44khz_16bit_stereo',
                    ssml: 'false',
                    b64: 'false'
                };
                
                // Construire l'URL
                const queryString = Object.keys(params)
                    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                    .join('&');
                
                const apiUrl = `https://api.voicerss.org/?${queryString}`;
                
                console.log('Appel API vers:', apiUrl.substring(0, 100) + '...');
                
                // Cr√©er un √©l√©ment audio pour tester l'URL
                const audioElement = new Audio();
                audioElement.preload = 'auto';
                
                audioElement.oncanplaythrough = () => {
                    // L'audio est pr√™t √† √™tre jou√©
                    console.log('Audio charg√© avec succ√®s');
                    
                    // Pour r√©cup√©rer le blob, on fait une requ√™te fetch s√©par√©e
                    fetch(apiUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Erreur HTTP ${response.status}`);
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            if (blob.size === 0) {
                                throw new Error('Fichier audio vide');
                            }
                            resolve(blob);
                        })
                        .catch(error => {
                            reject(new Error(`√âchec de t√©l√©chargement : ${error.message}`));
                        });
                };
                
                audioElement.onerror = (error) => {
                    console.error('Erreur audio:', error);
                    reject(new Error('Impossible de charger l\'audio. V√©rifiez votre cl√© API et votre connexion.'));
                };
                
                // D√©finir un timeout
                setTimeout(() => {
                    reject(new Error('Timeout : L\'API ne r√©pond pas'));
                }, 10000);
                
                // Tester l'URL
                audioElement.src = apiUrl;
            });
        }

        function playAudio() {
            if (elements.audioPlayer.src) {
                elements.audioPlayer.play();
            }
        }

        // ============================================
        // √âV√âNEMENTS
        // ============================================

        // Bouton de g√©n√©ration
        elements.generateBtn.addEventListener('click', generateAudio);

        // Entr√©e dans le champ texte
        elements.textInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                generateAudio();
            }
        });

        // ============================================
        // EXEMPLE DE TEXTE
        // ============================================

        // Exemple de texte par d√©faut
        if (elements.textInput.value.trim() === '') {
            elements.textInput.value = "Bonjour ! Je suis heureux de vous pr√©senter ce g√©n√©rateur audio fonctionnel. Votre texte sera converti en un vrai fichier MP3 t√©l√©chargeable.";
            updateCharCount();
        }

        // Message de bienvenue
        console.log(`
        ========================================
        G√âN√âRATEUR AUDIO FONCTIONNEL
        ========================================
        Instructions :
        1. Configurez votre cl√© API VoiceRSS
        2. √âcrivez votre texte (max 300 caract√®res)
        3. Cliquez sur "G√©n√©rer l'Audio MP3"
        4. T√©l√©chargez votre fichier MP3
        
        Cl√© API actuelle : ${userApiKey ? '‚úì Configur√©e' : '‚úó Non configur√©e'}
        ========================================
        `);
    </script>
</body>
</html>
