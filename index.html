<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur Texte-Voix Naturelle avec VoiceRSS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            padding: 40px;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.8rem;
            background: linear-gradient(90deg, #1a2a6c, #b21f1f);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .input-section, .controls-section, .voices-section, .apikey-section {
            margin-bottom: 30px;
        }

        h2 {
            color: #34495e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }

        .api-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .api-input-group {
            flex: 1;
            min-width: 300px;
        }

        .api-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .api-note {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .api-note a {
            color: #3498db;
            text-decoration: none;
        }

        .api-note a:hover {
            text-decoration: underline;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
        }

        .value-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }

        .voices-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .voice-option {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-option:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }

        .voice-option.selected {
            border-color: #2ecc71;
            background-color: #e8f6f3;
        }

        .voice-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .voice-lang {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
        }

        .play-btn {
            background: linear-gradient(90deg, #2ecc71, #1abc9c);
            color: white;
        }

        .play-btn:hover {
            background: linear-gradient(90deg, #27ae60, #16a085);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .stop-btn {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: white;
        }

        .stop-btn:hover {
            background: linear-gradient(90deg, #c0392b, #a93226);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .pause-btn {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
        }

        .pause-btn:hover {
            background: linear-gradient(90deg, #2980b9, #1c5a7d);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .reset-btn {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            color: white;
        }

        .reset-btn:hover {
            background: linear-gradient(90deg, #e67e22, #d35400);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .download-btn {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            color: white;
        }

        .download-btn:hover {
            background: linear-gradient(90deg, #8e44ad, #7d3c98);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .status.ready {
            background-color: #e8f6f3;
            color: #27ae60;
        }

        .status.speaking {
            background-color: #ebf5fb;
            color: #2980b9;
        }

        .status.paused {
            background-color: #fef9e7;
            color: #f39c12;
        }

        .status.stopped {
            background-color: #fbebee;
            color: #e74c3c;
        }

        .status.processing {
            background-color: #f4ecf7;
            color: #9b59b6;
        }

        .example-text {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
            cursor: pointer;
            text-decoration: underline;
            display: inline-block;
        }

        .example-text:hover {
            color: #3498db;
        }

        .instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .instructions ul {
            padding-left: 20px;
            color: #555;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            width: 100%;
        }

        .engine-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .engine-option {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .engine-option:hover {
            border-color: #3498db;
            background-color: #f0f8ff;
        }

        .engine-option.selected {
            border-color: #2ecc71;
            background-color: #e8f6f3;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .voice-option, .api-input-group {
                min-width: 100%;
            }
            
            button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Convertisseur Texte-Voix Naturelle</h1>
            <p class="subtitle">Transformez votre texte en parole naturelle avec téléchargement MP3 et support VoiceRSS</p>
        </header>

        <section class="apikey-section">
            <h2>Configuration VoiceRSS</h2>
            <div class="engine-selector">
                <div class="engine-option selected" id="engineBrowser">Moteur Navigateur</div>
                <div class="engine-option" id="engineVoiceRSS">VoiceRSS (Téléchargement MP3)</div>
            </div>
            
            <div id="voiceRSSConfig" class="hidden">
                <div class="api-container">
                    <div class="api-input-group">
                        <label for="apiKey">Clé API VoiceRSS</label>
                        <input type="text" id="apiKey" placeholder="Entrez votre clé API VoiceRSS">
                    </div>
                </div>
                <p class="api-note">
                    Obtenez une clé API gratuite sur <a href="https://www.voicerss.org/" target="_blank">VoiceRSS.org</a>. 
                    La version gratuite offre 350 requêtes par jour avec une limite de 100kb par requête.
                </p>
            </div>
        </section>

        <section class="input-section">
            <h2>Texte à convertir</h2>
            <textarea id="textInput" placeholder="Écrivez ou collez votre texte ici...">Bonjour ! Je suis votre assistant vocal. Je peux lire votre texte avec une voix naturelle, en respectant parfaitement la ponctuation : les virgules, les points, les points d'interrogation et d'exclamation.

Cette technologie utilise l'API de synthèse vocale de votre navigateur ou VoiceRSS. Vous pouvez ajuster la vitesse, le volume et choisir parmi différentes voix disponibles.

Avec VoiceRSS, vous pouvez également télécharger le fichier audio en MP3 pour l'utiliser hors ligne.</textarea>
            <div class="stats">
                <span id="charCount">0 caractères</span>
                <span id="wordCount">0 mots</span>
                <span id="sentenceCount">0 phrases</span>
                <span id="audioSize">0 KB</span>
            </div>
            <p class="example-text" id="loadExample">Charger un exemple de texte avec ponctuation</p>
        </section>

        <section class="controls-section">
            <h2>Paramètres de la voix</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="rate">Vitesse de parole</label>
                    <div class="slider-container">
                        <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="rateValue">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="pitch">Ton de la voix</label>
                    <div class="slider-container">
                        <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="pitchValue">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="volume">Volume</label>
                    <div class="slider-container">
                        <input type="range" id="volume" min="0" max="1" step="0.1" value="1">
                        <span class="value-display" id="volumeValue">1.0</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="voices-section">
            <h2>Sélectionnez une voix</h2>
            <p id="voicesLoading">Chargement des voix disponibles...</p>
            <div class="voices-container" id="voicesContainer">
                <!-- Les options de voix seront ajoutées dynamiquement -->
            </div>
        </section>

        <div class="buttons">
            <button id="playBtn" class="play-btn">
                <span>▶ Lire le texte</span>
            </button>
            <button id="pauseBtn" class="pause-btn" disabled>
                <span>⏸ Pause</span>
            </button>
            <button id="resumeBtn" class="pause-btn" disabled>
                <span>▶ Reprendre</span>
            </button>
            <button id="stopBtn" class="stop-btn" disabled>
                <span>⏹ Arrêter</span>
            </button>
            <button id="downloadBtn" class="download-btn" disabled>
                <span>⬇ Télécharger MP3</span>
            </button>
            <button id="resetBtn" class="reset-btn">
                <span>↺ Réinitialiser</span>
            </button>
        </div>

        <div class="status ready" id="status">
            Prêt à convertir le texte en voix
        </div>

        <div class="instructions">
            <h3>Instructions d'utilisation</h3>
            <ul>
                <li><strong>Étape 1 :</strong> Choisissez entre le moteur navigateur (gratuit) ou VoiceRSS (nécessite une clé API)</li>
                <li><strong>Étape 2 :</strong> Saisissez ou collez votre texte dans la zone de texte</li>
                <li><strong>Étape 3 :</strong> Ajustez les paramètres (vitesse, ton, volume) selon vos préférences</li>
                <li><strong>Étape 4 :</strong> Sélectionnez une voix parmi celles disponibles</li>
                <li><strong>Étape 5 :</strong> Cliquez sur "Lire le texte" pour démarrer la synthèse vocale</li>
                <li><strong>Étape 6 :</strong> Avec VoiceRSS, utilisez "Télécharger MP3" pour sauvegarder l'audio</li>
                <li><strong>Note :</strong> VoiceRSS permet le téléchargement mais nécessite une clé API gratuite</li>
            </ul>
        </div>
    </div>

    <footer>
        <p>Outil de synthèse vocale avec support VoiceRSS - Compatible avec les navigateurs modernes</p>
    </footer>

    <script>
        // Éléments DOM
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const sentenceCount = document.getElementById('sentenceCount');
        const audioSize = document.getElementById('audioSize');
        const rateSlider = document.getElementById('rate');
        const rateValue = document.getElementById('rateValue');
        const pitchSlider = document.getElementById('pitch');
        const pitchValue = document.getElementById('pitchValue');
        const volumeSlider = document.getElementById('volume');
        const volumeValue = document.getElementById('volumeValue');
        const voicesContainer = document.getElementById('voicesContainer');
        const voicesLoading = document.getElementById('voicesLoading');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const status = document.getElementById('status');
        const loadExample = document.getElementById('loadExample');
        const apiKeyInput = document.getElementById('apiKey');
        const voiceRSSConfig = document.getElementById('voiceRSSConfig');
        const engineBrowser = document.getElementById('engineBrowser');
        const engineVoiceRSS = document.getElementById('engineVoiceRSS');

        // Variables globales
        let synth = window.speechSynthesis;
        let voices = [];
        let selectedVoice = null;
        let isPlaying = false;
        let isPaused = false;
        let currentUtterance = null;
        let audioBlob = null;
        let audioUrl = null;
        let currentEngine = 'browser'; // 'browser' ou 'voicerss'
        let audioElement = null;

        // Configuration des moteurs
        engineBrowser.addEventListener('click', () => {
            engineBrowser.classList.add('selected');
            engineVoiceRSS.classList.remove('selected');
            voiceRSSConfig.classList.add('hidden');
            currentEngine = 'browser';
            updateButtons();
            status.textContent = 'Moteur navigateur activé';
            status.className = 'status ready';
        });

        engineVoiceRSS.addEventListener('click', () => {
            engineBrowser.classList.remove('selected');
            engineVoiceRSS.classList.add('selected');
            voiceRSSConfig.classList.remove('hidden');
            currentEngine = 'voicerss';
            updateButtons();
            status.textContent = 'VoiceRSS activé - Entrez votre clé API';
            status.className = 'status ready';
        });

        // Mettre à jour les statistiques du texte
        function updateTextStats() {
            const text = textInput.value;
            const charCountValue = text.length;
            const wordCountValue = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            
            // Compter les phrases (séparées par . ! ?)
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const sentenceCountValue = sentences.length;
            
            // Estimation de la taille audio (approximative)
            const estimatedAudioSize = Math.round(charCountValue * 0.05); // Estimation approximative en KB
            
            charCount.textContent = `${charCountValue} caractères`;
            wordCount.textContent = `${wordCountValue} mots`;
            sentenceCount.textContent = `${sentenceCountValue} phrases`;
            audioSize.textContent = `${estimatedAudioSize} KB estimés`;
        }

        // Mettre à jour l'affichage des valeurs des sliders
        rateSlider.addEventListener('input', () => {
            rateValue.textContent = rateSlider.value;
        });

        pitchSlider.addEventListener('input', () => {
            pitchValue.textContent = pitchSlider.value;
        });

        volumeSlider.addEventListener('input', () => {
            volumeValue.textContent = volumeSlider.value;
        });

        // Charger les voix disponibles pour le navigateur
        function loadVoices() {
            voices = synth.getVoices();
            voicesLoading.style.display = 'none';
            voicesContainer.innerHTML = '';
            
            // Filtrer pour obtenir principalement des voix en français
            const frenchVoices = voices.filter(voice => 
                voice.lang.startsWith('fr') || 
                voice.lang.startsWith('en') || 
                voice.name.toLowerCase().includes('french')
            );
            
            // Si pas de voix en français, montrer toutes les voix
            const voicesToShow = frenchVoices.length > 0 ? frenchVoices : voices;
            
            if (voicesToShow.length === 0) {
                voicesContainer.innerHTML = '<p>Aucune voix disponible. Votre navigateur peut ne pas supporter la synthèse vocale.</p>';
                return;
            }
            
            // Trier les voix par langue
            voicesToShow.sort((a, b) => {
                if (a.lang < b.lang) return -1;
                if (a.lang > b.lang) return 1;
                return 0;
            });
            
            // Créer les options de voix
            voicesToShow.forEach((voice, index) => {
                const voiceOption = document.createElement('div');
                voiceOption.className = 'voice-option';
                if (index === 0) {
                    voiceOption.classList.add('selected');
                    selectedVoice = voice;
                }
                
                voiceOption.innerHTML = `
                    <div class="voice-name">${voice.name}</div>
                    <div class="voice-lang">${voice.lang} - ${voice.localService ? 'Locale' : 'Réseau'}</div>
                `;
                
                voiceOption.addEventListener('click', () => {
                    // Retirer la sélection de toutes les voix
                    document.querySelectorAll('.voice-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    
                    // Ajouter la sélection à la voix choisie
                    voiceOption.classList.add('selected');
                    selectedVoice = voice;
                });
                
                voicesContainer.appendChild(voiceOption);
            });
        }

        // Initialiser les voix du navigateur
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }

        // Charger les voix au démarrage
        loadVoices();

        // Mettre à jour les stats du texte au chargement et à chaque modification
        textInput.addEventListener('input', updateTextStats);
        updateTextStats();

        // Utiliser VoiceRSS pour la synthèse vocale
        async function speakWithVoiceRSS() {
            const text = textInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                alert('Veuillez entrer votre clé API VoiceRSS.');
                return;
            }
            
            if (text === '') {
                alert('Veuillez saisir du texte à lire.');
                return;
            }
            
            // Désactiver les boutons pendant le traitement
            playBtn.disabled = true;
            status.textContent = 'Génération de l\'audio en cours...';
            status.className = 'status processing';
            
            try {
                // Préparer les paramètres pour VoiceRSS
                const params = new URLSearchParams({
                    key: apiKey,
                    src: text,
                    hl: 'fr-fr', // Langue française
                    v: 'Louis',  // Voix masculine française (Louis)
                    r: rateSlider.value, // Vitesse
                    c: 'MP3',    // Format audio
                    f: '44khz_16bit_stereo', // Qualité audio
                    ssml: 'false',
                    b64: 'true'  // Retourner l'audio en base64
                });
                
                // Appeler l'API VoiceRSS
                const response = await fetch(`https://api.voicerss.org/?${params.toString()}`);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const audioData = await response.text();
                
                // Vérifier si une erreur est retournée par l'API
                if (audioData.startsWith('ERROR')) {
                    throw new Error(`VoiceRSS: ${audioData}`);
                }
                
                // Convertir la réponse base64 en Blob
                const byteCharacters = atob(audioData);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                audioBlob = new Blob([byteArray], { type: 'audio/mp3' });
                
                // Créer une URL pour le Blob
                if (audioUrl) {
                    URL.revokeObjectURL(audioUrl);
                }
                audioUrl = URL.createObjectURL(audioBlob);
                
                // Créer ou réutiliser un élément audio
                if (!audioElement) {
                    audioElement = new Audio();
                }
                
                audioElement.src = audioUrl;
                audioElement.volume = parseFloat(volumeSlider.value);
                
                // Configurer les événements de l'élément audio
                audioElement.onplay = () => {
                    isPlaying = true;
                    isPaused = false;
                    updateButtons();
                    status.textContent = 'Lecture en cours...';
                    status.className = 'status speaking';
                };
                
                audioElement.onpause = () => {
                    isPaused = true;
                    updateButtons();
                    status.textContent = 'Lecture en pause';
                    status.className = 'status paused';
                };
                
                audioElement.onended = () => {
                    isPlaying = false;
                    isPaused = false;
                    updateButtons();
                    status.textContent = 'Lecture terminée - Prêt à télécharger';
                    status.className = 'status ready';
                };
                
                audioElement.onerror = (error) => {
                    console.error('Erreur audio:', error);
                    isPlaying = false;
                    isPaused = false;
                    updateButtons();
                    status.textContent = 'Erreur lors de la lecture audio';
                    status.className = 'status stopped';
                    playBtn.disabled = false;
                };
                
                // Activer le bouton de téléchargement
                downloadBtn.disabled = false;
                
                // Démarrer la lecture
                await audioElement.play();
                playBtn.disabled = false;
                
            } catch (error) {
                console.error('Erreur VoiceRSS:', error);
                alert(`Erreur lors de la génération audio: ${error.message}`);
                status.textContent = 'Erreur lors de la génération audio';
                status.className = 'status stopped';
                playBtn.disabled = false;
            }
        }

        // Utiliser la synthèse vocale du navigateur
        function speakWithBrowser() {
            const text = textInput.value.trim();
            if (text === '') {
                alert('Veuillez saisir du texte à lire.');
                return;
            }
            
            if (!selectedVoice) {
                alert('Aucune voix sélectionnée. Veuillez choisir une voix.');
                return;
            }
            
            // Arrêter toute lecture en cours
            if (currentUtterance) {
                synth.cancel();
            }
            
            // Désactiver le bouton de téléchargement pour le navigateur
            downloadBtn.disabled = true;
            
            // Créer une nouvelle utterance
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            // Configurer l'utterance
            currentUtterance.voice = selectedVoice;
            currentUtterance.rate = parseFloat(rateSlider.value);
            currentUtterance.pitch = parseFloat(pitchSlider.value);
            currentUtterance.volume = parseFloat(volumeSlider.value);
            
            // Gérer les événements
            currentUtterance.onstart = () => {
                isPlaying = true;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture en cours...';
                status.className = 'status speaking';
            };
            
            currentUtterance.onend = () => {
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture terminée';
                status.className = 'status ready';
            };
            
            currentUtterance.onerror = (event) => {
                console.error('Erreur de synthèse vocale:', event);
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Erreur lors de la lecture';
                status.className = 'status stopped';
            };
            
            currentUtterance.onpause = () => {
                isPaused = true;
                updateButtons();
                status.textContent = 'Lecture en pause';
                status.className = 'status paused';
            };
            
            currentUtterance.onresume = () => {
                isPaused = false;
                updateButtons();
                status.textContent = 'Reprise de la lecture';
                status.className = 'status speaking';
            };
            
            // Démarrer la synthèse
            synth.speak(currentUtterance);
        }

        // Gérer la lecture du texte
        playBtn.addEventListener('click', () => {
            if (isPlaying && !isPaused) {
                return;
            }
            
            if (currentEngine === 'voicerss') {
                speakWithVoiceRSS();
            } else {
                speakWithBrowser();
            }
        });

        // Gérer la pause
        pauseBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss') {
                if (audioElement && isPlaying && !isPaused) {
                    audioElement.pause();
                    isPaused = true;
                    updateButtons();
                    status.textContent = 'Lecture en pause';
                    status.className = 'status paused';
                }
            } else {
                if (isPlaying && !isPaused) {
                    synth.pause();
                    isPaused = true;
                    updateButtons();
                    status.textContent = 'Lecture en pause';
                    status.className = 'status paused';
                }
            }
        });

        // Gérer la reprise
        resumeBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss') {
                if (audioElement && isPlaying && isPaused) {
                    audioElement.play();
                    isPaused = false;
                    updateButtons();
                    status.textContent = 'Reprise de la lecture';
                    status.className = 'status speaking';
                }
            } else {
                if (isPlaying && isPaused) {
                    synth.resume();
                    isPaused = false;
                    updateButtons();
                    status.textContent = 'Reprise de la lecture';
                    status.className = 'status speaking';
                }
            }
        });

        // Gérer l'arrêt
        stopBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss') {
                if (audioElement) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                }
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture arrêtée';
                status.className = 'status stopped';
            } else {
                synth.cancel();
                isPlaying = false;
                isPaused = false;
                updateButtons();
                status.textContent = 'Lecture arrêtée';
                status.className = 'status stopped';
            }
        });

        // Gérer le téléchargement
        downloadBtn.addEventListener('click', () => {
            if (!audioBlob) {
                alert('Aucun fichier audio à télécharger. Veuillez d\'abord générer l\'audio.');
                return;
            }
            
            // Créer un lien de téléchargement
            const downloadLink = document.createElement('a');
            downloadLink.href = audioUrl;
            
            // Générer un nom de fichier basé sur le contenu
            const text = textInput.value.trim().substring(0, 50).replace(/[^a-z0-9]/gi, '_');
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            downloadLink.download = `synthèse_vocale_${text}_${timestamp}.mp3`;
            
            // Déclencher le téléchargement
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            status.textContent = 'Téléchargement démarré';
            setTimeout(() => {
                status.textContent = 'Prêt à convertir le texte en voix';
                status.className = 'status ready';
            }, 2000);
        });

        // Gérer la réinitialisation
        resetBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss') {
                if (audioElement) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                }
                if (audioUrl) {
                    URL.revokeObjectURL(audioUrl);
                    audioUrl = null;
                }
                audioBlob = null;
            } else {
                synth.cancel();
            }
            
            isPlaying = false;
            isPaused = false;
            
            // Réinitialiser les sliders
            rateSlider.value = 1;
            rateValue.textContent = '1.0';
            pitchSlider.value = 1;
            pitchValue.textContent = '1.0';
            volumeSlider.value = 1;
            volumeValue.textContent = '1.0';
            
            // Réinitialiser le texte
            textInput.value = '';
            updateTextStats();
            
            // Réinitialiser la sélection de voix
            if (voices.length > 0 && currentEngine === 'browser') {
                document.querySelectorAll('.voice-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.querySelector('.voice-option').classList.add('selected');
                selectedVoice = voices[0];
            }
            
            // Désactiver le bouton de téléchargement
            downloadBtn.disabled = true;
            
            updateButtons();
            status.textContent = 'Prêt à convertir le texte en voix';
            status.className = 'status ready';
        });

        // Mettre à jour l'état des boutons
        function updateButtons() {
            const isVoiceRSS = currentEngine === 'voicerss';
            
            playBtn.disabled = (isPlaying && !isPaused) || (isVoiceRSS && !apiKeyInput.value.trim());
            pauseBtn.disabled = !isPlaying || isPaused;
            resumeBtn.disabled = !isPlaying || !isPaused;
            stopBtn.disabled = !isPlaying;
            
            // Le bouton de téléchargement n'est disponible que pour VoiceRSS avec un audio généré
            if (isVoiceRSS) {
                downloadBtn.disabled = !audioBlob;
            } else {
                downloadBtn.disabled = true;
            }
        }

        // Charger un exemple de texte
        loadExample.addEventListener('click', () => {
            textInput.value = `La synthèse vocale, ou text-to-speech (TTS), est une technologie qui convertit le texte en parole artificielle.

Cette technologie est utilisée dans de nombreux domaines : assistance aux personnes malvoyantes, navigation GPS, assistants vocaux, et bien plus encore.

Le respect de la ponctuation est essentiel pour une lecture naturelle. Par exemple, une virgule introduit une courte pause, un point une pause plus longue, et un point d'interrogation modifie l'intonation de la voix.

Avec VoiceRSS, vous pouvez générer un fichier audio de haute qualité et le télécharger au format MP3 pour une utilisation hors ligne.

Essayez avec votre propre texte maintenant !`;
            updateTextStats();
        });

        // Mettre à jour l'état des boutons quand la clé API change
        apiKeyInput.addEventListener('input', updateButtons);

        // Initialiser l'état des boutons
        updateButtons();
    </script>
</body>
</html>
